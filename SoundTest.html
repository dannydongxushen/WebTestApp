<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­éŸ³è¯†åˆ«æµ‹è¯• - æœ¬åœ°æµ‹è¯•ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .description {
            color: #7f8c8d;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        .input-group {
            margin-bottom: 25px;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        #resultText {
            width: 100%;
            height: 120px;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        #resultText:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .recorder-container {
            margin: 30px 0;
        }
        
        .voice-btn {
            background: linear-gradient(135deg, #3498db, #2ecc71);
            color: white;
            border: none;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
        }
        
        .voice-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.6);
        }
        
        .voice-btn.recording {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            animation: pulse 1.5s infinite;
        }
        
        .voice-btn.playback {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .wave-container {
            margin: 20px auto;
            width: 200px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .wave-bar {
            width: 4px;
            height: 20px;
            background: #3498db;
            margin: 0 2px;
            border-radius: 2px;
            animation: wave 1.2s infinite ease-in-out;
        }
        
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        .wave-bar:nth-child(6) { animation-delay: 0.5s; }
        .wave-bar:nth-child(7) { animation-delay: 0.6s; }
        .wave-bar:nth-child(8) { animation-delay: 0.7s; }
        
        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(2); }
        }
        
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
            display: none;
        }
        
        .status.recording {
            background: #e8f6f3;
            color: #27ae60;
            display: block;
        }
        
        .status.processing {
            background: #e8f4fd;
            color: #2980b9;
            display: block;
        }
        
        .status.error {
            background: #fdeaea;
            color: #e74c3c;
            display: block;
        }
        
        .status.success {
            background: #e8f6f3;
            color: #27ae60;
            display: block;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            display: block;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
            transition: all 0.3s ease;
            margin-top: 20px;
            display: none;
        }
        
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.6);
        }
        
        .audio-player {
            margin-top: 20px;
            width: 100%;
            border-radius: 10px;
            display: none;
        }
        
        .info {
            margin-top: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 14px;
            color: #7f8c8d;
            text-align: left;
        }
        
        .info h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .info ul {
            padding-left: 20px;
        }
        
        .info li {
            margin-bottom: 8px;
        }
        
        .recording-info {
            margin-top: 15px;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 15px;
            background: #2c3e50;
            color: white;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .debug-toggle {
            background: #34495e;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .debug-toggle:hover {
            background: #2c3e50;
        }
        
        .local-mode {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            background: #fff3cd;
            color: #856404;
            font-size: 14px;
        }
        
        .browser-recognition-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .browser-recognition-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(155, 89, 182, 0.6);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>è¯­éŸ³è¯†åˆ«æµ‹è¯• - æœ¬åœ°æµ‹è¯•ç‰ˆ</h1>
        <p class="description">æ”¯æŒæµè§ˆå™¨åŸç”Ÿè¯­éŸ³è¯†åˆ«å’Œç™¾åº¦APIè¯†åˆ«</p>
        
        <div class="local-mode" id="localMode">
            å½“å‰ä¸ºæœ¬åœ°æµ‹è¯•æ¨¡å¼ - ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿè¯­éŸ³è¯†åˆ«
        </div>
        
        <div class="input-group">
            <label for="resultText">è¯†åˆ«ç»“æœï¼š</label>
            <textarea id="resultText" placeholder="è¯†åˆ«ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
        </div>
        
        <div class="recorder-container">
            <button id="voiceBtn" class="voice-btn">ğŸ¤</button>
            
            <div class="wave-container" id="waveContainer" style="display: none;">
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
            </div>
            
            <div id="statusMessage" class="status"></div>
            
            <audio id="audioPlayer" class="audio-player" controls></audio>
            
            <button id="submitBtn" class="submit-btn">æäº¤è¯­éŸ³è¿›è¡Œè¯†åˆ«</button>
            
            <button id="browserRecognitionBtn" class="browser-recognition-btn">ä½¿ç”¨æµè§ˆå™¨è¯­éŸ³è¯†åˆ«</button>
            
            <div class="recording-info" id="recordingInfo"></div>
            
            <button class="debug-toggle" id="debugToggle">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
            
            <div class="debug-info" id="debugInfo"></div>
        </div>
        
        <div class="info">
            <h3>ä½¿ç”¨è¯´æ˜ï¼š</h3>
            <ul>
                <li>ç‚¹å‡»éº¦å…‹é£æŒ‰é’®å¼€å§‹å½•éŸ³ï¼ˆæœ¬åœ°å½•éŸ³ï¼‰</li>
                <li>å½•éŸ³å®Œæˆåï¼Œå¯ä»¥ç‚¹å‡»æ’­æ”¾æŒ‰é’®é‡å¬å½•éŸ³</li>
                <li>ç‚¹å‡»"ä½¿ç”¨æµè§ˆå™¨è¯­éŸ³è¯†åˆ«"è¿›è¡Œå®æ—¶è¯­éŸ³è¯†åˆ«</li>
                <li>è¯†åˆ«ç»“æœå°†æ˜¾ç¤ºåœ¨ä¸Šæ–¹æ–‡æœ¬æ¡†ä¸­</li>
                <li>ç‚¹å‡»"æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯"æŸ¥çœ‹APIè¯·æ±‚è¯¦æƒ…</li>
                <li>æ­¤ç‰ˆæœ¬æ”¯æŒæœ¬åœ°æµ‹è¯•ï¼Œæ— éœ€Netlify Functions</li>
            </ul>
        </div>
    </div>

    <script>
        // é…ç½®
        const CONFIG = {
            // åœ¨æœ¬åœ°æ¨¡å¼ä¸‹ä¸ä½¿ç”¨ä»£ç†
            tokenProxyUrl: '/api/baidu-token',
            speechProxyUrl: '/api/baidu-speech',
            isLocalMode: window.location.protocol === 'file:'
        };
        
        // DOMå…ƒç´ 
        const voiceBtn = document.getElementById('voiceBtn');
        const waveContainer = document.getElementById('waveContainer');
        const statusMessage = document.getElementById('statusMessage');
        const resultText = document.getElementById('resultText');
        const audioPlayer = document.getElementById('audioPlayer');
        const submitBtn = document.getElementById('submitBtn');
        const recordingInfo = document.getElementById('recordingInfo');
        const debugInfo = document.getElementById('debugInfo');
        const debugToggle = document.getElementById('debugToggle');
        const localMode = document.getElementById('localMode');
        const browserRecognitionBtn = document.getElementById('browserRecognitionBtn');
        
        // å…¨å±€å˜é‡
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let currentAudioBlob = null;
        let accessToken = '';
        let recordingStartTime = 0;
        let recordingTimer = null;
        let recognition = null;
        let isBrowserRecognitionActive = false;
        
        // è°ƒè¯•æ—¥å¿—
        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            debugInfo.appendChild(logEntry);
            debugInfo.scrollTop = debugInfo.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }
        
        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status ${type}`;
            debugLog(`çŠ¶æ€: ${message} (${type})`);
        }
        
        // æ›´æ–°å½•éŸ³æ—¶é•¿æ˜¾ç¤º
        function updateRecordingTime() {
            if (!isRecording) return;
            
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            recordingInfo.textContent = `å½•éŸ³æ—¶é•¿: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // åˆå§‹åŒ–æµè§ˆå™¨è¯­éŸ³è¯†åˆ«
        function initBrowserRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showStatus('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½', 'error');
                return false;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'zh-CN';
            
            recognition.onstart = function() {
                isBrowserRecognitionActive = true;
                showStatus('æ­£åœ¨è†å¬ä¸­...è¯·å¼€å§‹è¯´è¯', 'recording');
                browserRecognitionBtn.textContent = 'åœæ­¢è¯­éŸ³è¯†åˆ«';
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                resultText.value = transcript;
                showStatus('è¯†åˆ«å®Œæˆ', 'success');
                debugLog(`æµè§ˆå™¨è¯­éŸ³è¯†åˆ«ç»“æœ: ${transcript}`);
            };
            
            recognition.onerror = function(event) {
                console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                showStatus(`è¯­éŸ³è¯†åˆ«é”™è¯¯: ${event.error}`, 'error');
                stopBrowserRecognition();
            };
            
            recognition.onend = function() {
                stopBrowserRecognition();
            };
            
            return true;
        }
        
        // å¼€å§‹æµè§ˆå™¨è¯­éŸ³è¯†åˆ«
        function startBrowserRecognition() {
            if (!recognition) {
                if (!initBrowserRecognition()) {
                    return;
                }
            }
            
            try {
                recognition.start();
            } catch (error) {
                console.error('å¼€å§‹è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
                showStatus('å¼€å§‹è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // åœæ­¢æµè§ˆå™¨è¯­éŸ³è¯†åˆ«
        function stopBrowserRecognition() {
            isBrowserRecognitionActive = false;
            browserRecognitionBtn.textContent = 'ä½¿ç”¨æµè§ˆå™¨è¯­éŸ³è¯†åˆ«';
            
            if (recognition) {
                try {
                    recognition.stop();
                } catch (error) {
                    // å¿½ç•¥åœæ­¢æ—¶çš„é”™è¯¯
                }
            }
        }
        
        // åˆ‡æ¢æµè§ˆå™¨è¯­éŸ³è¯†åˆ«çŠ¶æ€
        function toggleBrowserRecognition() {
            if (isBrowserRecognitionActive) {
                stopBrowserRecognition();
            } else {
                startBrowserRecognition();
            }
        }
        
        // é€šè¿‡Netlify Functionsè·å–ç™¾åº¦è¯­éŸ³è¯†åˆ«çš„è®¿é—®ä»¤ç‰Œ
        async function getBaiduAccessToken() {
            if (CONFIG.isLocalMode) {
                throw new Error('æœ¬åœ°æ¨¡å¼ä¸‹æ— æ³•ä½¿ç”¨ç™¾åº¦è¯­éŸ³è¯†åˆ«API');
            }
            
            try {
                debugLog("é€šè¿‡Netlify Functionsè·å–ç™¾åº¦è®¿é—®ä»¤ç‰Œ...");
                const url = CONFIG.tokenProxyUrl;
                debugLog(`è¯·æ±‚URL: ${url}`);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                debugLog(`ä»¤ç‰Œè¯·æ±‚å“åº”çŠ¶æ€: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                debugLog(`ä»¤ç‰Œå“åº”æ•°æ®: ${JSON.stringify(data)}`);
                
                if (data.access_token) {
                    accessToken = data.access_token;
                    debugLog(`æˆåŠŸè·å–è®¿é—®ä»¤ç‰Œ: ${accessToken.substring(0, 20)}...`);
                    return data.access_token;
                } else {
                    throw new Error(`æ— æ³•è·å–ç™¾åº¦è¯­éŸ³è¯†åˆ«è®¿é—®ä»¤ç‰Œ: ${data.error_description || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('è·å–ç™¾åº¦è¯­éŸ³è¯†åˆ«ä»¤ç‰Œå¤±è´¥:', error);
                debugLog(`è·å–ä»¤ç‰Œå¤±è´¥: ${error.message}`);
                showStatus('è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                throw error;
            }
        }
        
        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                debugLog("å¼€å§‹å½•éŸ³...");
                // è¯·æ±‚éº¦å…‹é£æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true
                    } 
                });
                
                debugLog("éº¦å…‹é£è®¿é—®æƒé™å·²è·å–");
                
                // åˆ›å»ºMediaRecorderå®ä¾‹
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                audioChunks = [];
                
                // æ”¶é›†éŸ³é¢‘æ•°æ®
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                // å½•éŸ³åœæ­¢æ—¶çš„å¤„ç†
                mediaRecorder.onstop = async () => {
                    debugLog("å½•éŸ³å·²åœæ­¢ï¼Œå¤„ç†å½•éŸ³æ•°æ®...");
                    // åˆ›å»ºéŸ³é¢‘Blob
                    currentAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    debugLog(`å½•éŸ³Blobå¤§å°: ${currentAudioBlob.size} å­—èŠ‚`);
                    
                    // åˆ›å»ºæ’­æ”¾URL
                    const audioURL = URL.createObjectURL(currentAudioBlob);
                    audioPlayer.src = audioURL;
                    
                    // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“
                    stream.getTracks().forEach(track => track.stop());
                    
                    // æ›´æ–°UI
                    updateUIAfterRecording();
                };
                
                // å¼€å§‹å½•éŸ³
                mediaRecorder.start(100); // æ¯100msæ”¶é›†ä¸€æ¬¡æ•°æ®
                isRecording = true;
                recordingStartTime = Date.now();
                
                // å¼€å§‹è®¡æ—¶å™¨
                recordingTimer = setInterval(updateRecordingTime, 1000);
                
                // æ›´æ–°UI
                voiceBtn.textContent = 'â¹ï¸';
                voiceBtn.classList.add('recording');
                waveContainer.style.display = 'flex';
                showStatus('æ­£åœ¨å½•éŸ³... ç‚¹å‡»æŒ‰é’®åœæ­¢å½•éŸ³', 'recording');
                submitBtn.style.display = 'none';
                audioPlayer.style.display = 'none';
                
            } catch (error) {
                console.error('å¼€å§‹å½•éŸ³å¤±è´¥:', error);
                debugLog(`å¼€å§‹å½•éŸ³å¤±è´¥: ${error.message}`);
                showStatus('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®', 'error');
            }
        }
        
        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // æ¸…é™¤è®¡æ—¶å™¨
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }
                
                // æ›´æ–°UI
                voiceBtn.textContent = 'â–¶ï¸';
                voiceBtn.classList.remove('recording');
                voiceBtn.classList.add('playback');
                waveContainer.style.display = 'none';
                showStatus('å½•éŸ³å®Œæˆï¼ç‚¹å‡»æ’­æ”¾æŒ‰é’®é‡å¬å½•éŸ³', 'success');
            }
        }
        
        // å½•éŸ³å®Œæˆåçš„UIæ›´æ–°
        function updateUIAfterRecording() {
            submitBtn.style.display = 'block';
            audioPlayer.style.display = 'block';
            debugLog("UIå·²æ›´æ–°ï¼Œæ˜¾ç¤ºæäº¤æŒ‰é’®å’ŒéŸ³é¢‘æ’­æ”¾å™¨");
        }
        
        // æ’­æ”¾å½•éŸ³
        function playRecording() {
            if (currentAudioBlob) {
                audioPlayer.play();
                showStatus('æ­£åœ¨æ’­æ”¾å½•éŸ³...', 'processing');
                debugLog("å¼€å§‹æ’­æ”¾å½•éŸ³");
                
                audioPlayer.onended = () => {
                    showStatus('æ’­æ”¾å®Œæˆ', 'success');
                    debugLog("å½•éŸ³æ’­æ”¾å®Œæˆ");
                };
            }
        }
        
        // åˆ‡æ¢å½•éŸ³/æ’­æ”¾çŠ¶æ€
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else if (currentAudioBlob) {
                // å¦‚æœæœ‰å½•éŸ³ï¼Œåˆ™æ’­æ”¾
                playRecording();
            } else {
                // æ²¡æœ‰å½•éŸ³ï¼Œå¼€å§‹å½•éŸ³
                startRecording();
            }
        }
        
        // å¤„ç†å½•éŸ³æ•°æ®å¹¶è°ƒç”¨ç™¾åº¦API
        async function submitRecording() {
            if (!currentAudioBlob) {
                showStatus('æ²¡æœ‰å¯æäº¤çš„å½•éŸ³', 'error');
                debugLog("æäº¤å¤±è´¥ï¼šæ²¡æœ‰å¯æäº¤çš„å½•éŸ³");
                return;
            }
            
            if (CONFIG.isLocalMode) {
                showStatus('æœ¬åœ°æ¨¡å¼ä¸‹æ— æ³•ä½¿ç”¨ç™¾åº¦è¯­éŸ³è¯†åˆ«APIï¼Œè¯·ä½¿ç”¨æµè§ˆå™¨è¯­éŸ³è¯†åˆ«åŠŸèƒ½', 'warning');
                return;
            }
            
            try {
                showStatus('æ­£åœ¨å¤„ç†è¯­éŸ³...', 'processing');
                submitBtn.disabled = true;
                debugLog("å¼€å§‹æäº¤å½•éŸ³åˆ°ç™¾åº¦API");
                
                // è·å–è®¿é—®ä»¤ç‰Œ
                await getBaiduAccessToken();
                
                // å°†Blobè½¬æ¢ä¸ºBase64
                debugLog("å°†å½•éŸ³Blobè½¬æ¢ä¸ºBase64...");
                const base64Audio = await blobToBase64(currentAudioBlob);
                debugLog(`Base64éŸ³é¢‘æ•°æ®é•¿åº¦: ${base64Audio.length} å­—ç¬¦`);
                
                // é€šè¿‡Netlify Functionsè°ƒç”¨ç™¾åº¦è¯­éŸ³è¯†åˆ«API
                const result = await callBaiduSpeechAPI(base64Audio);
                
                // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
                if (result && result.result && result.result[0]) {
                    resultText.value = result.result[0];
                    showStatus('è¯†åˆ«æˆåŠŸï¼', 'success');
                    debugLog(`è¯†åˆ«æˆåŠŸ: ${result.result[0]}`);
                } else {
                    throw new Error('æœªè¯†åˆ«åˆ°æœ‰æ•ˆè¯­éŸ³');
                }
                
            } catch (error) {
                console.error('è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
                debugLog(`è¯­éŸ³è¯†åˆ«å¤±è´¥: ${error.message}`);
                showStatus(`è¯†åˆ«å¤±è´¥: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
            }
        }
        
        // å°†Blobè½¬æ¢ä¸ºBase64
        function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    // ç§»é™¤dataURLå‰ç¼€ï¼Œåªä¿ç•™Base64æ•°æ®
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.readAsDataURL(blob);
            });
        }
        
        // é€šè¿‡Netlify Functionsè°ƒç”¨ç™¾åº¦è¯­éŸ³è¯†åˆ«API
        async function callBaiduSpeechAPI(base64Audio) {
            debugLog("é€šè¿‡Netlify Functionsè°ƒç”¨ç™¾åº¦è¯­éŸ³è¯†åˆ«API...");
            
            // ç™¾åº¦è¯­éŸ³è¯†åˆ«APIå‚æ•°
            const requestData = {
                format: 'wav',
                rate: 16000,
                channel: 1,
                token: accessToken,
                cuid: 'baidu_speech_demo',
                len: base64Audio.length,
                speech: base64Audio,
                dev_pid: 1537
            };
            
            debugLog(`APIè¯·æ±‚æ•°æ®: ${JSON.stringify({
                ...requestData,
                speech: `${base64Audio.substring(0, 50)}...`
            })}`);
            
            try {
                const response = await fetch(CONFIG.speechProxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                debugLog(`APIå“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                debugLog(`APIå“åº”æ•°æ®: ${JSON.stringify(result)}`);
                
                if (result.err_no === 0) {
                    return result;
                } else {
                    throw new Error(`APIé”™è¯¯: ${result.err_msg} (é”™è¯¯ç : ${result.err_no})`);
                }
                
            } catch (error) {
                debugLog(`APIè°ƒç”¨å¤±è´¥: ${error.message}`);
                throw error;
            }
        }
        
        // ç»‘å®šäº‹ä»¶
        voiceBtn.addEventListener('click', toggleRecording);
        submitBtn.addEventListener('click', submitRecording);
        browserRecognitionBtn.addEventListener('click', toggleBrowserRecognition);
        debugToggle.addEventListener('click', () => {
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
            debugToggle.textContent = debugInfo.style.display === 'none' ? 'æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯' : 'éšè—è°ƒè¯•ä¿¡æ¯';
        });
        
        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            if (CONFIG.isLocalMode) {
                localMode.style.display = 'block';
                showStatus('æœ¬åœ°æµ‹è¯•æ¨¡å¼å·²å¯ç”¨ï¼Œä½¿ç”¨æµè§ˆå™¨è¯­éŸ³è¯†åˆ«åŠŸèƒ½', 'warning');
                submitBtn.style.display = 'none'; // åœ¨æœ¬åœ°æ¨¡å¼ä¸‹éšè—æäº¤æŒ‰é’®
            } else {
                localMode.style.display = 'none';
                showStatus('ç‚¹å‡»éº¦å…‹é£æŒ‰é’®å¼€å§‹å½•éŸ³', 'processing');
            }
            
            debugLog("é¡µé¢åˆå§‹åŒ–å®Œæˆ");
            debugLog(`æµè§ˆå™¨ä¿¡æ¯: ${navigator.userAgent}`);
            debugLog(`æ˜¯å¦æ”¯æŒMediaRecorder: ${!!window.MediaRecorder}`);
            debugLog(`æ˜¯å¦æ”¯æŒè¯­éŸ³è¯†åˆ«: ${!!(window.SpeechRecognition || window.webkitSpeechRecognition)}`);
            debugLog(`å½“å‰æ¨¡å¼: ${CONFIG.isLocalMode ? 'æœ¬åœ°æµ‹è¯•' : 'Netlifyéƒ¨ç½²'}`);
            
            // åˆå§‹åŒ–æµè§ˆå™¨è¯­éŸ³è¯†åˆ«
            initBrowserRecognition();
        });
    </script>
</body>
</html>