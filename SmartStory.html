<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå„¿ç«¥æ•…äº‹ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffd93d);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .selection-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .selection-group {
                grid-template-columns: 1fr;
            }
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input[type="text"], select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .generate-btn {
            background: #4ecdc4;
            color: white;
        }

        .generate-btn:hover:not(:disabled) {
            background: #3db4ac;
            transform: translateY(-2px);
        }

        .play-btn {
            background: #ff6b6b;
            color: white;
        }

        .play-btn:hover:not(:disabled) {
            background: #ff5252;
            transform: translateY(-2px);
        }

        .voice-input-btn {
            background: #6c5ce7;
            color: white;
            padding: 10px 15px;
            margin-top: 10px;
            width: 100%;
        }

        .voice-input-btn:hover:not(:disabled) {
            background: #5b4cd8;
            transform: translateY(-2px);
        }

        .voice-input-btn.recording {
            background: #e74c3c;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .output-section {
            margin-top: 30px;
        }

        .story-display {
            background: #f8f9fa;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 20px;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
            line-height: 1.8;
            font-size: 16px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4ecdc4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .audio-controls {
            margin-top: 20px;
            text-align: center;
        }

        .audio-controls audio {
            width: 100%;
            margin-top: 10px;
            border-radius: 12px;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e1e8ed;
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #bdc3c7;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .step.active .step-number {
            background: #4ecdc4;
        }

        .step.completed .step-number {
            background: #ff6b6b;
        }

        .step-text {
            font-size: 14px;
            color: #7f8c8d;
            text-align: center;
        }

        .step.active .step-text {
            color: #4ecdc4;
            font-weight: 600;
        }

        .step.completed .step-text {
            color: #ff6b6b;
        }

        .debug-info {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
            color: #666;
            display: none;
        }

        .audio-info {
            margin-top: 10px;
            padding: 10px;
            background: #e8f4fc;
            border-radius: 5px;
            font-size: 14px;
            display: none;
        }

        .story-stats {
            margin-top: 10px;
            text-align: right;
            font-size: 14px;
            color: #7f8c8d;
        }

        .prompt-suggestions {
            margin-top: 10px;
            font-size: 14px;
            color: #7f8c8d;
            text-align: center;
        }

        .prompt-suggestions button {
            background: none;
            border: none;
            color: #3498db;
            text-decoration: underline;
            cursor: pointer;
            padding: 0;
            margin: 0 5px;
            font-size: 14px;
        }

        .voice-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            display: none;
        }

        /* è¯­éŸ³è¾“å…¥æ§åˆ¶é¢æ¿ */
        .voice-control-panel {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e1e8ed;
            display: none;
        }

        .voice-visualization {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px;
            margin-bottom: 15px;
        }

        .voice-bar {
            width: 4px;
            height: 20px;
            margin: 0 2px;
            background: #6c5ce7;
            border-radius: 2px;
            animation: voiceWave 1.2s infinite ease-in-out;
        }

        @keyframes voiceWave {
            0%, 40%, 100% {
                transform: scaleY(0.5);
            }
            20% {
                transform: scaleY(1.5);
            }
        }

        .voice-control-buttons {
            display: flex;
            gap: 10px;
        }

        .voice-control-buttons button {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }

        .play-recording-btn {
            background: #4ecdc4;
            color: white;
        }

        .re-record-btn {
            background: #ff9f43;
            color: white;
        }

        .submit-recording-btn {
            background: #6c5ce7;
            color: white;
        }

        .recording-timer {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #e74c3c;
        }

        .recording-info {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }

        /* æ’­æ”¾è¿›åº¦æ¡æ ·å¼ */
        .playback-progress {
            margin: 15px 0;
            display: none;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: #e1e8ed;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: #6c5ce7;
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .progress-time {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 12px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§šâ€â™€ï¸ AIå„¿ç«¥éŸ³é¢‘æ•…äº‹ç”Ÿæˆå™¨</h1>
            <p>ä½¿ç”¨DeepSeek/MiniMaxç”Ÿæˆå„¿ç«¥éŸ³é¢‘æ•…äº‹</p>
        </div>

        <div class="content">
            <div class="step-indicator">
                <div class="step completed" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-text">è®¾ç½®æ•…äº‹å‚æ•°</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-text">ç”Ÿæˆæ•…äº‹</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-text">åˆæˆè¯­éŸ³</div>
                </div>
            </div>

            <div class="input-section">
                <div class="input-group">
                    <label for="keywords">æ•…äº‹ä¸»é¢˜æˆ–å…³é”®è¯ï¼š</label>
                    <input type="text" id="keywords" placeholder="ä¾‹å¦‚ï¼šå‹‡æ•¢çš„å°å…”å­ã€é­”æ³•æ£®æ—å†’é™©ã€å‹è°Šçš„åŠ›é‡">
                    <div class="prompt-suggestions" id="promptSuggestions">
                        è¯•è¯•è¿™äº›ä¸»é¢˜: 
                        <button id="suggestion1">å‹‡æ•¢çš„å°å…”å­</button>
                        <button id="suggestion2">é­”æ³•æ£®æ—å†’é™©</button>
                        <button id="suggestion3">å‹è°Šçš„åŠ›é‡</button>
                        <button id="randomSuggestion">éšæœºä¸»é¢˜</button>
                    </div>
                    <button class="voice-input-btn" id="voiceInputBtn">
                        ğŸ¤ è¯­éŸ³è¾“å…¥æç¤ºè¯
                    </button>
                    
                    <!-- è¯­éŸ³æ§åˆ¶é¢æ¿ -->
                    <div class="voice-control-panel" id="voiceControlPanel">
                        <div class="recording-timer" id="recordingTimer">00:00</div>
                        <div class="voice-visualization" id="voiceVisualization">
                            <!-- åŠ¨æ€å£°æ³¢æ¡å°†é€šè¿‡JSç”Ÿæˆ -->
                        </div>
                        
                        <div class="playback-progress" id="playbackProgress">
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="progressBar"></div>
                            </div>
                            <div class="progress-time">
                                <span id="currentTime">00:00</span>
                                <span id="totalTime">00:00</span>
                            </div>
                        </div>
                        
                        <div class="voice-control-buttons">
                            <button class="play-recording-btn" id="playRecordingBtn" disabled>
                                â–¶ï¸ æ’­æ”¾å½•éŸ³
                            </button>
                            <button class="re-record-btn" id="reRecordBtn">
                                ğŸ”„ é‡æ–°å½•å…¥
                            </button>
                            <button class="submit-recording-btn" id="submitRecordingBtn" disabled>
                                âœ… æäº¤è¯†åˆ«
                            </button>
                        </div>
                        <div class="recording-info">
                            æœ€é•¿å¯å½•åˆ¶60ç§’éŸ³é¢‘
                        </div>
                    </div>
                    
                    <div class="voice-status" id="voiceStatus"></div>
                </div>

                <div class="selection-group">
                    <div class="input-group">
                        <label for="childGender">å„¿ç«¥æ€§åˆ«ï¼š</label>
                        <select id="childGender">
                            <option value="ç”·å­©">ğŸ‘¦ ç”·å­©</option>
                            <option value="å¥³å­©">ğŸ‘§ å¥³å­©</option>
                            <option value="ä¸é™" selected>ğŸ‘¦ğŸ‘§ ä¸é™</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="ageGroup">å¹´é¾„æ®µï¼š</label>
                        <select id="ageGroup">
                            <option value="3-5å²" selected>3-5å²ï¼ˆå¹¼å„¿ï¼‰</option>
                            <option value="6-8å²">6-8å²ï¼ˆå„¿ç«¥ï¼‰</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="storyLength">æ•…äº‹é•¿åº¦ï¼š</label>
                        <select id="storyLength">
                            <option value="500">500å­—ï¼ˆçŸ­ç¯‡ï¼‰</option>
                            <option value="1000" selected>1000å­—ï¼ˆä¸­ç¯‡ï¼‰</option>
                            <option value="2000">2000å­—ï¼ˆé•¿ç¯‡ï¼‰</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="voiceSelect">è®²è¿°è€…å£°éŸ³ï¼š</label>
                        <select id="voiceSelect">
                            <!-- MiniMaxå›½é™…ç«™ç‚¹æ”¯æŒçš„è¯­éŸ³ID -->
                            <option value="moss_audio_ce44fc67-7ce3-11f0-8de5-96e35d26fb85">ğŸ¤– è«æ–¯ä¸­æ–‡éŸ³è‰²1</option>
                            <option value="moss_audio_aaa1346a-7ce7-11f0-8e61-2e6e3c7ee85d">ğŸ¤– è«æ–¯ä¸­æ–‡éŸ³è‰²2</option>
                            <option value="Chinese (Mandarin)_Lyrical_Voice">ğŸµ ä¸­æ–‡æŠ’æƒ…éŸ³è‰²</option>
                            <option value="Chinese (Mandarin)_HK_Flight_Attendant">âœˆï¸ ä¸­æ–‡ç©ºä¹˜éŸ³è‰²</option>
                            <option value="English_expressive_narrator">ğŸ­ è‹±æ–‡å¯Œæœ‰è¡¨ç°åŠ›çš„æ—ç™½</option>
                            <option value="English_Graceful_Lady">ğŸ‘© è‹±æ–‡ä¼˜é›…çš„å¥³å£°</option>
                            <option value="English_Insightful_Speaker">ğŸ’¡ è‹±æ–‡å¯Œæœ‰æ´å¯ŸåŠ›çš„æ¼”è®²è€…</option>
                        </select>
                    </div>
                </div>

                <div class="button-group">
                    <button class="generate-btn" id="generateBtn">
                        ğŸª„ ç”Ÿæˆå®šåˆ¶æ•…äº‹
                    </button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loadingText">æ­£åœ¨ç”Ÿæˆæ•…äº‹ï¼Œè¯·ç¨å€™...</p>
            </div>

            <div id="statusMessage"></div>

            <div class="output-section">
                <label>ç”Ÿæˆçš„å„¿ç«¥æ•…äº‹ï¼š</label>
                <div class="story-display" id="storyDisplay">
                    <p style="color: #7f8c8d; text-align: center; margin-top: 80px;">
                        è®¾ç½®æ•…äº‹å‚æ•°å¹¶ç‚¹å‡»ç”Ÿæˆï¼Œæ‚¨å°†ä¼šçœ‹åˆ°ä¸€ä¸ªç²¾å½©çš„å®šåˆ¶å„¿ç«¥æ•…äº‹...
                    </p>
                </div>
                <div class="story-stats" id="storyStats"></div>

                <div class="debug-info" id="debugInfo"></div>
                <div class="audio-info" id="audioInfo"></div>

                <div class="audio-controls">
                    <button class="play-btn" id="playBtn" disabled>
                        ğŸ”Š æ’­æ”¾æ•…äº‹è¯­éŸ³
                    </button>
                    <audio id="audioPlayer" controls style="display: none;"></audio>
                </div>
            </div>
        </div>
    </div>

    <script>
        // APIå¯†é’¥é…ç½®
        const CONFIG = {
            deepseekApiKey: 'sk-aae2a862b3ab4c498fa91f73c76ef9d3',
            minimaxApiKey: 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJHcm91cE5hbWUiOiJEb25neHUgU2hlbiIsIlVzZXJOYW1lIjoiVmlydHVhbCBWaWV3IFRlY2hub2xvZ3kiLCJBY2NvdW50IjoiIiwiU3ViamVjdElEIjoiMTg5MDEzNjYyNDY1MDUyMzU2NyIsIlBob25lIjoiIiwiR3JvdXBJRCI6IjE4OTAxMzY2MjQ2NDIxMzQ5NTkiLCJQYWdlTmFtZSI6IiIsIk1haWwiOiJkYW5ueS5kb25neHUuc2hlbkBnbWFpbC5jb20iLCJDcmVhdGVUaW1lIjoiMjAyNS0xMS0yMyAyMTozNzowMCIsIlRva2VuVHlwZSI6MSwiaXNzIjoibWluaW1heCJ9.skY-6yvS8VV321ta7LxzoubBOWhlAzaJDrQ4HbK3_vaVtKMPuakO1lGBYJeGJDhQ12xhnlGn5z5fjQVb99N9BkekaNUY2n3PHdO01Ub6Wgfe3w62sGx538WhidIlwvgEMsFNhGbtHj2FGwaef6ZmGlxM6JmXg3J_bYSKYNu5UwlvZeXq3mddJdBCRlZ3d5RzKx9XpxpmeeRh_VzHlW6af5u1gbfD5Lc9vrxa5aNLqbYgUL6DO_RkXsy7kszlEnzOT-lWslgWmwh2lDS28LDEKacEZCymva196R-Dg2N1klgP585T1ZVud7UjWUZ445kmzU0W2tAroGDuQ9rCZVdBAA',
            baiduSpeech: {
                appId: '7258968',
                apiKey: 'aFlSHz5qGHV2ZID4daou3Gqq',
                secretKey: 'Jva3tSRyrH3fLHW98cxGhlDKQfCQ6RsJ'
            }
        };

        // å…¨å±€å˜é‡
        let currentAudioUrl = null;
        let recognition = null;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordedAudioBlob = null;
        let recordingTimer = null;
        let recordingSeconds = 0;
        let maxRecordingTime = 60;
        let playbackAudio = null;
        let playbackTimer = null;
        let isPlayingRecording = false;
        let recordedAudioDuration = 0;

        // æœ¬åœ°æç¤ºè¯åº“
        const PROMPT_SUGGESTIONS = [
            "å‹‡æ•¢çš„å°å…”å­",
            "é­”æ³•æ£®æ—å†’é™©", 
            "å‹è°Šçš„åŠ›é‡",
            "æµ·åº•ä¸–ç•Œå¥‡é‡",
            "å¤ªç©ºæ¢é™©è®°",
            "ä¼šè¯´è¯çš„å°åŠ¨ç‰©",
            "å½©è™¹æ¡¥çš„ç§˜å¯†",
            "æ¢¦æƒ³æˆçœŸçš„æ•…äº‹",
            "å‹‡æ•¢é¢å¯¹ææƒ§",
            "åˆ†äº«çš„å¿«ä¹",
            "å¸®åŠ©ä»–äººçš„å°è‹±é›„",
            "å››å­£çš„å˜åŒ–",
            "æ˜Ÿæ˜Ÿçš„æ„¿æœ›",
            "æœˆäº®çš„ç§˜å¯†",
            "å¤ªé˜³çš„å¾®ç¬‘"
        ];

        // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
        function updateStepIndicator(step) {
            const steps = ['step1', 'step2', 'step3'];
            steps.forEach((stepId, index) => {
                const stepElement = document.getElementById(stepId);
                if (index + 1 < step) {
                    stepElement.classList.add('completed');
                    stepElement.classList.remove('active');
                } else if (index + 1 === step) {
                    stepElement.classList.add('active');
                    stepElement.classList.remove('completed');
                } else {
                    stepElement.classList.remove('active', 'completed');
                }
            });
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);
            }
        }

        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function showDebugInfo(info) {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = `<strong>è°ƒè¯•ä¿¡æ¯:</strong> ${info}`;
            debugDiv.style.display = 'block';
        }

        // æ˜¾ç¤ºéŸ³é¢‘ä¿¡æ¯
        function showAudioInfo(info) {
            const audioInfo = document.getElementById('audioInfo');
            audioInfo.innerHTML = info;
            audioInfo.style.display = 'block';
        }

        // æ˜¾ç¤ºæ•…äº‹ç»Ÿè®¡ä¿¡æ¯
        function showStoryStats(wordCount, charCount) {
            const statsDiv = document.getElementById('storyStats');
            statsDiv.innerHTML = `å­—æ•°: ${wordCount} | å­—ç¬¦æ•°: ${charCount}`;
        }

        // æ˜¾ç¤ºè¯­éŸ³çŠ¶æ€
        function showVoiceStatus(message, type = 'info') {
            const voiceStatus = document.getElementById('voiceStatus');
            voiceStatus.innerHTML = message;
            voiceStatus.style.display = 'block';
            voiceStatus.className = `voice-status ${type}`;
        }

        // éšè—è¯­éŸ³çŠ¶æ€
        function hideVoiceStatus() {
            const voiceStatus = document.getElementById('voiceStatus');
            voiceStatus.style.display = 'none';
        }

        // åå…­è¿›åˆ¶å­—ç¬¦ä¸²è½¬å­—èŠ‚æ•°ç»„
        function hexToBytes(hex) {
            const bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substr(i, 2), 16));
            }
            return new Uint8Array(bytes);
        }

        // éšæœºç”Ÿæˆæç¤ºè¯
        function generateRandomPrompt() {
            const randomIndex = Math.floor(Math.random() * PROMPT_SUGGESTIONS.length);
            return PROMPT_SUGGESTIONS[randomIndex];
        }

        // è®¾ç½®éšæœºæç¤ºè¯
        function setRandomPrompt() {
            const keywordsInput = document.getElementById('keywords');
            keywordsInput.value = generateRandomPrompt();
        }

        // ç”Ÿæˆæ•…äº‹æç¤ºè¯
        function generateStoryPrompt(keywords, childGender, ageGroup, storyLength) {
            let prompt = `è¯·åˆ›ä½œä¸€ä¸ªå„¿ç«¥æ•…äº‹ï¼Œä¸»é¢˜æ˜¯å…³äº"${keywords}"ã€‚`;
            
            // æ ¹æ®æ€§åˆ«è°ƒæ•´
            if (childGender !== "ä¸é™") {
                prompt += ` è¿™ä¸ªæ•…äº‹ä¸»è¦é¢å‘${childGender}ï¼Œ`;
            }
            
            // æ ¹æ®å¹´é¾„æ®µè°ƒæ•´
            if (ageGroup === "3-5å²") {
                prompt += ` é€‚åˆ3-5å²å¹¼å„¿ï¼Œè¦æ±‚è¯­è¨€ç®€å•æ˜“æ‡‚ï¼Œå¥å­çŸ­å°ï¼Œæƒ…èŠ‚ç®€å•æ˜äº†ï¼Œå¯Œæœ‰ç«¥è¶£å’Œæƒ³è±¡åŠ›ã€‚`;
            } else {
                prompt += ` é€‚åˆ6-8å²å„¿ç«¥ï¼Œå¯ä»¥æœ‰ç¨å¾®å¤æ‚ä¸€ç‚¹çš„æƒ…èŠ‚å’Œæ›´å¤šç»†èŠ‚ï¼Œä½†ä»è¦ä¿æŒè¯­è¨€ç”ŸåŠ¨æœ‰è¶£ã€‚`;
            }
            
            // æ ¹æ®å­—æ•°è°ƒæ•´
            prompt += ` æ•…äº‹é•¿åº¦å¤§çº¦${storyLength}å­—ã€‚`;
            
            // æ•…äº‹è¦æ±‚
            prompt += ` è¦æ±‚æ•…äº‹æ¸©é¦¨ã€ç§¯æå‘ä¸Šã€å¯Œæœ‰æ•™è‚²æ„ä¹‰ï¼ŒåŒ…å«æ˜ç¡®çš„å¼€å§‹ã€å‘å±•å’Œç»“å°¾ï¼Œä½†è¯·ä¸è¦ä½¿ç”¨"èµ·æ‰¿è½¬åˆ"è¿™æ ·çš„æœ¯è¯­ã€‚`;
            
            // è¯­è¨€é£æ ¼
            prompt += ` ä½¿ç”¨é€‚åˆå„¿ç«¥çš„è¯­è¨€é£æ ¼ï¼Œé¿å…å¤æ‚è¯æ±‡ï¼Œå¯ä»¥é€‚å½“ä½¿ç”¨æ‹Ÿå£°è¯å’Œé‡å¤å¥å¼å¢å¼ºè¶£å‘³æ€§ã€‚`;
            
            return prompt;
        }

        // è·å–ç™¾åº¦è®¿é—®ä»¤ç‰Œ
        async function getBaiduAccessToken() {
            try {
                console.log('é€šè¿‡Netlify Functionè·å–ç™¾åº¦Access Token...');
                
                // è°ƒç”¨Netlify Function
                const response = await fetch('/.netlify/functions/baidu-proxy/baidu-token', {
                method: 'POST'
                });
                
                if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Netlify Functionå“åº”:', data);
                
                if (data.access_token) {
                console.log('æˆåŠŸè·å–åˆ°Access Token');
                return data.access_token;
                } else {
                throw new Error(`è·å–ä»¤ç‰Œå¤±è´¥: ${data.error_description || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
            } catch (error) {
                console.error('é€šè¿‡Netlify Functionè·å–Access Tokenå¤±è´¥:', error);
                throw error;
            }
        }

        // æ”¹è¿›çš„è¯­éŸ³çŠ¶æ€æ˜¾ç¤ºå‡½æ•°
        function showVoiceStatus(message, type = 'info', duration = 0) {
            const voiceStatus = document.getElementById('voiceStatus');
            voiceStatus.innerHTML = message;
            voiceStatus.style.display = 'block';
            voiceStatus.className = `voice-status ${type}`;
            
            // å¦‚æœæ˜¯é”™è¯¯ä¿¡æ¯ï¼Œæ˜¾ç¤ºæ›´é•¿æ—¶é—´ï¼›å¦‚æœæ˜¯æˆåŠŸä¿¡æ¯ï¼Œè‡ªåŠ¨éšè—
            if (type === 'error' && duration === 0) {
                duration = 10000; // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º10ç§’
            } else if (type === 'success' && duration === 0) {
                duration = 5000; // æˆåŠŸä¿¡æ¯æ˜¾ç¤º5ç§’
            }
            
            if (duration > 0) {
                setTimeout(() => {
                    if (voiceStatus.innerHTML === message) {
                        voiceStatus.style.display = 'none';
                    }
                }, duration);
            }
        }

        // åœ¨submitRecordingå‡½æ•°ä¸­æ·»åŠ è¿›åº¦æŒ‡ç¤º
        async function submitRecording() {
            if (!recordedAudioBlob) {
                showVoiceStatus('âŒ æ²¡æœ‰å¯æäº¤çš„å½•éŸ³', 'error');
                return;
            }
            
            // ç¦ç”¨æäº¤æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
            const submitBtn = document.getElementById('submitRecordingBtn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'ğŸ”„ è¯†åˆ«ä¸­...';
            
            try {
                showVoiceStatus('æ­£åœ¨è¯†åˆ«è¯­éŸ³...', 'info');
                
                // æ˜¾ç¤ºéŸ³é¢‘æ ¼å¼ä¿¡æ¯
                showDebugInfo(`æäº¤çš„éŸ³é¢‘æ ¼å¼: ${recordedAudioBlob.type}, å¤§å°: ${(recordedAudioBlob.size/1024).toFixed(2)}KB`);
                
                // 1. å…ˆè·å–è®¿é—®ä»¤ç‰Œ
                showVoiceStatus('è·å–è®¿é—®ä»¤ç‰Œ...', 'info');
                const accessToken = await getBaiduAccessToken();
                
                // 2. å°†å½•éŸ³è½¬æ¢ä¸ºbase64
                showVoiceStatus('å¤„ç†éŸ³é¢‘æ•°æ®...', 'info');
                const base64Audio = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                    reader.readAsDataURL(recordedAudioBlob);
                });
                
                // 3. å‡†å¤‡è¯·æ±‚æ•°æ®
                showVoiceStatus('æäº¤è¯­éŸ³è¯†åˆ«è¯·æ±‚...', 'info');
                const requestData = {
                    format: 'wav',
                    rate: 16000,
                    channel: 1,
                    token: accessToken,
                    cuid: 'netlify-story-app',
                    len: recordedAudioBlob.size,
                    speech: base64Audio
                };
                
                console.log('é€šè¿‡Netlify Functionæäº¤è¯­éŸ³è¯†åˆ«...', requestData);
                
                // 4. è°ƒç”¨Netlify Functionè¿›è¡Œè¯­éŸ³è¯†åˆ«
                const response = await fetchWithTimeout('/.netlify/functions/baidu-proxy/baidu-speech?token=' + accessToken, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                }, 15000);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('è¯­éŸ³è¯†åˆ«APIé”™è¯¯å“åº”:', errorText);
                    throw new Error(`è¯­éŸ³è¯†åˆ«APIé”™è¯¯: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('è¯­éŸ³è¯†åˆ«å®Œæ•´ç»“æœ:', result);
                
                if (result.err_no === 0) {
                    const transcript = result.result[0];
                    document.getElementById('keywords').value = transcript;
                    showVoiceStatus(`âœ… è¯†åˆ«æˆåŠŸ: "${transcript}"`, 'success');
                    
                    // éšè—è¯­éŸ³æ§åˆ¶é¢æ¿
                    document.getElementById('voiceControlPanel').style.display = 'none';
                    
                    return transcript;
                } else {
                    throw new Error(`è¯­éŸ³è¯†åˆ«å¤±è´¥: ${result.err_msg} (é”™è¯¯ç : ${result.err_no})`);
                }
                
            } catch (error) {
                console.error('æäº¤å½•éŸ³å¤±è´¥:', error);
                showVoiceStatus(`âŒ è¯†åˆ«å¤±è´¥: ${error.message}`, 'error');
                throw error;
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }       
        
        // åˆå§‹åŒ–åª’ä½“å½•éŸ³ï¼ˆå®Œæ•´ä¿®å¤ç‰ˆï¼‰
        async function initMediaRecorder() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½');
                }
                
                // ç¡®ä¿ä¹‹å‰çš„æµè¢«é‡Šæ”¾
                if (mediaRecorder && mediaRecorder.stream) {
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                }
                
                // è¯·æ±‚éŸ³é¢‘è¾“å…¥ï¼ŒæŒ‡å®šé‡‡æ ·ç‡
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000, // è®¾ç½®é‡‡æ ·ç‡ä¸º16000Hz
                        channelCount: 1,   // å•å£°é“
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                let recorderOptions = {};
                let willNeedConversion = false;
                
                // æ£€æµ‹æµè§ˆå™¨æ˜¯å¦æ”¯æŒWAVæ ¼å¼
                if (MediaRecorder.isTypeSupported('audio/wav')) {
                    recorderOptions = { mimeType: 'audio/wav' };
                    console.log('æµè§ˆå™¨æ”¯æŒç›´æ¥å½•åˆ¶WAVæ ¼å¼');
                } else {
                    // ä½¿ç”¨æµè§ˆå™¨é»˜è®¤æ ¼å¼ï¼ˆé€šå¸¸æ˜¯webmï¼‰ï¼Œåç»­éœ€è¦è½¬æ¢
                    console.log('æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥å½•åˆ¶WAVæ ¼å¼ï¼Œä½¿ç”¨é»˜è®¤æ ¼å¼ï¼Œåç»­éœ€è¦è½¬æ¢');
                    willNeedConversion = true;
                    
                    // å°è¯•ä½¿ç”¨å¸¸è§çš„æ”¯æŒæ ¼å¼
                    if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                        recorderOptions = { mimeType: 'audio/webm;codecs=opus' };
                    } else if (MediaRecorder.isTypeSupported('audio/webm')) {
                        recorderOptions = { mimeType: 'audio/webm' };
                    }
                    // å¦‚æœä¸æŒ‡å®šmimeTypeï¼Œæµè§ˆå™¨ä¼šä½¿ç”¨é»˜è®¤æ ¼å¼
                }
                
                // ä½¿ç”¨å…¨å±€mediaRecorderå˜é‡ï¼Œé¿å…é‡æ–°å£°æ˜
                mediaRecorder = new MediaRecorder(stream, recorderOptions);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    try {
                        let finalBlob;
                        const originalBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                        
                        // æ˜¾ç¤ºåŸå§‹éŸ³é¢‘ä¿¡æ¯
                        const originalFormat = mediaRecorder.mimeType || 'æœªçŸ¥æ ¼å¼';
                        const originalSize = (originalBlob.size / 1024).toFixed(2);
                        
                        // å¦‚æœéœ€è¦è½¬æ¢ä¸”ä¸æ˜¯WAVæ ¼å¼
                        if (willNeedConversion && !originalBlob.type.includes('wav')) {
                            showVoiceStatus('æ­£åœ¨è½¬æ¢éŸ³é¢‘æ ¼å¼ä¸ºWAV...', 'info');
                            console.log(`å¼€å§‹æ ¼å¼è½¬æ¢: ${originalFormat} -> audio/wav`);
                            
                            finalBlob = await convertToWav(audioChunks);
                            
                            // æ˜¾ç¤ºè½¬æ¢åçš„ä¿¡æ¯
                            showDebugInfo(`åŸå§‹æ ¼å¼: ${originalFormat}, å¤§å°: ${originalSize}KB â†’ è½¬æ¢å: ${finalBlob.type}, å¤§å°: ${(finalBlob.size/1024).toFixed(2)}KB`);
                            showVoiceStatus(`âœ… å½•éŸ³å®Œæˆ (å·²è½¬æ¢ä¸ºWAVæ ¼å¼)`, 'success');
                        } else {
                            finalBlob = originalBlob;
                            showDebugInfo(`éŸ³é¢‘æ ¼å¼: ${finalBlob.type}, å¤§å°: ${(finalBlob.size/1024).toFixed(2)}KB`);
                            showVoiceStatus(`âœ… å½•éŸ³å®Œæˆ`, 'success');
                        }
                        
                        recordedAudioBlob = finalBlob;
                        recordedAudioDuration = recordingSeconds;
                        
                        // å¯ç”¨æ’­æ”¾å’Œæäº¤æŒ‰é’®
                        document.getElementById('playRecordingBtn').disabled = false;
                        document.getElementById('submitRecordingBtn').disabled = false;
                        
                        // åœæ­¢å½•éŸ³åŠ¨ç”»
                        stopVoiceAnimation();
                        
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        document.getElementById('voiceInputBtn').textContent = 'ğŸ¤ è¯­éŸ³è¾“å…¥æç¤ºè¯';
                        document.getElementById('voiceInputBtn').classList.remove('recording');
                        
                        // æ¸…é™¤è®¡æ—¶å™¨
                        clearInterval(recordingTimer);
                        recordingSeconds = 0;
                        document.getElementById('recordingTimer').textContent = '00:00';
                        
                        // æ›´æ–°æ€»æ—¶é•¿æ˜¾ç¤º
                        updateTotalTimeDisplay();
                        
                    } catch (error) {
                        console.error('å¤„ç†å½•éŸ³æ•°æ®å¤±è´¥:', error);
                        showVoiceStatus('âŒ å¤„ç†å½•éŸ³å¤±è´¥', 'error');
                    }
                };
                
                return mediaRecorder;
            } catch (error) {
                console.error('åˆå§‹åŒ–åª’ä½“å½•éŸ³å¤±è´¥:', error);
                showVoiceStatus(`âŒ ${error.message}`, 'error');
                return null;
            }
        }

        // å°†å…¶ä»–æ ¼å¼çš„éŸ³é¢‘è½¬æ¢ä¸ºWAVæ ¼å¼ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        async function convertToWav(audioChunks) {
            return new Promise((resolve, reject) => {
                // åˆ›å»ºåŸå§‹Blob
                const originalBlob = new Blob(audioChunks);
                const originalType = audioChunks.length > 0 ? audioChunks[0].type : 'unknown';
                
                const reader = new FileReader();
                reader.onload = async function() {
                    try {
                        // åˆ›å»ºAudioContextï¼ŒæŒ‡å®š16000Hzé‡‡æ ·ç‡
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)({
                            sampleRate: 16000
                        });
                        
                        // è§£ç åŸå§‹éŸ³é¢‘æ•°æ®
                        const audioBuffer = await audioContext.decodeAudioData(reader.result);
                        console.log(`åŸå§‹éŸ³é¢‘ä¿¡æ¯: é‡‡æ ·ç‡=${audioBuffer.sampleRate}Hz, å£°é“æ•°=${audioBuffer.numberOfChannels}, æ—¶é•¿=${audioBuffer.duration.toFixed(2)}ç§’`);
                        
                        // å¦‚æœå·²ç»æ˜¯16000Hzå•å£°é“ï¼Œç›´æ¥è½¬æ¢æ ¼å¼
                        if (audioBuffer.sampleRate === 16000 && audioBuffer.numberOfChannels === 1) {
                            console.log('éŸ³é¢‘å‚æ•°ç¬¦åˆè¦æ±‚ï¼Œç›´æ¥è½¬æ¢æ ¼å¼');
                            const wavBlob = audioBufferToWav(audioBuffer);
                            resolve(wavBlob);
                            return;
                        }
                        
                        // éœ€è¦é‡æ–°é‡‡æ ·æˆ–è½¬æ¢å£°é“
                        console.log('éŸ³é¢‘éœ€è¦é‡æ–°é‡‡æ ·æˆ–è½¬æ¢å£°é“');
                        
                        // è®¡ç®—ç›®æ ‡é•¿åº¦ï¼ˆä¿æŒæ—¶é•¿ä¸å˜ï¼‰
                        const targetLength = Math.floor(audioBuffer.length * 16000 / audioBuffer.sampleRate);
                        
                        // åˆ›å»ºç¦»çº¿ä¸Šä¸‹æ–‡è¿›è¡Œé‡æ–°é‡‡æ ·
                        const offlineContext = new OfflineAudioContext({
                            numberOfChannels: 1, // å•å£°é“
                            length: targetLength,
                            sampleRate: 16000
                        });
                        
                        const source = offlineContext.createBufferSource();
                        
                        // å¦‚æœæ˜¯å¤šå£°é“ï¼Œæ··éŸ³ä¸ºå•å£°é“
                        if (audioBuffer.numberOfChannels > 1) {
                            const mixedBuffer = audioContext.createBuffer(1, audioBuffer.length, audioBuffer.sampleRate);
                            const mixedData = mixedBuffer.getChannelData(0);
                            
                            // ç®€å•çš„å£°é“æ··åˆï¼šå–å„å£°é“å¹³å‡å€¼
                            for (let i = 0; i < audioBuffer.length; i++) {
                                let sum = 0;
                                for (let channel = 0; channel < audioBuffer.numberOfChannels; channel++) {
                                    sum += audioBuffer.getChannelData(channel)[i];
                                }
                                mixedData[i] = sum / audioBuffer.numberOfChannels;
                            }
                            source.buffer = mixedBuffer;
                        } else {
                            source.buffer = audioBuffer;
                        }
                        
                        source.connect(offlineContext.destination);
                        source.start();
                        
                        // æ¸²æŸ“ä¸ºæ–°çš„éŸ³é¢‘Buffer
                        const renderedBuffer = await offlineContext.startRendering();
                        console.log(`è½¬æ¢åéŸ³é¢‘ä¿¡æ¯: é‡‡æ ·ç‡=${renderedBuffer.sampleRate}Hz, å£°é“æ•°=${renderedBuffer.numberOfChannels}, æ—¶é•¿=${renderedBuffer.duration.toFixed(2)}ç§’`);
                        
                        // å°†AudioBufferè½¬æ¢ä¸ºWAVæ ¼å¼çš„Blob
                        const wavBlob = audioBufferToWav(renderedBuffer);
                        resolve(wavBlob);
                        
                    } catch (error) {
                        console.error('éŸ³é¢‘è½¬æ¢å¤±è´¥:', error);
                        // å¦‚æœè½¬æ¢å¤±è´¥ï¼Œè¿”å›åŸå§‹Blob
                        showDebugInfo(`æ ¼å¼è½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ ¼å¼: ${originalType}`);
                        resolve(originalBlob);
                    }
                };
                
                reader.onerror = () => {
                    console.error('æ–‡ä»¶è¯»å–å¤±è´¥');
                    reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                };
                
                reader.readAsArrayBuffer(originalBlob);
            });
        }

        // å°†AudioBufferè½¬æ¢ä¸ºWAV Blobï¼ˆä¿æŒä¸å˜ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯æœ‰æ•ˆçš„ï¼‰
        function audioBufferToWav(buffer) {
            const numChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const format = 1; // PCM
            const bitDepth = 16;
            
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numChannels * bytesPerSample;
            
            const bufferLength = buffer.length * numChannels * bytesPerSample;
            const dataLength = bufferLength;
            const headerLength = 44;
            const totalLength = headerLength + dataLength;
            
            const arrayBuffer = new ArrayBuffer(totalLength);
            const view = new DataView(arrayBuffer);
            
            // WAVæ–‡ä»¶å¤´
            writeString(view, 0, 'RIFF');
            view.setUint32(4, totalLength - 8, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);
            
            // å†™å…¥PCMæ•°æ®
            let offset = 44;
            for (let i = 0; i < buffer.length; i++) {
                for (let channel = 0; channel < numChannels; channel++) {
                    const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
                    view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                    offset += 2;
                }
            }
            
            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }

        // è¾…åŠ©å‡½æ•°ï¼šå†™å…¥å­—ç¬¦ä¸²åˆ°DataViewï¼ˆä¿æŒä¸å˜ï¼‰
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        // æ›´æ–°æ€»æ—¶é•¿æ˜¾ç¤º
        function updateTotalTimeDisplay() {
            if (recordedAudioDuration > 0) {
                const totalMinutes = Math.floor(recordedAudioDuration / 60);
                const totalSeconds = Math.floor(recordedAudioDuration % 60);
                document.getElementById('totalTime').textContent = 
                    `${totalMinutes.toString().padStart(2, '0')}:${totalSeconds.toString().padStart(2, '0')}`;
            }
        }

        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                // é‡ç½®çŠ¶æ€
                audioChunks = [];
                recordedAudioBlob = null;
                recordedAudioDuration = 0;
                
                // ç¡®ä¿ä¹‹å‰çš„éŸ³é¢‘æ’­æ”¾åœæ­¢
                if (playbackAudio) {
                    playbackAudio.pause();
                    clearInterval(playbackTimer);
                    document.getElementById('playbackProgress').style.display = 'none';
                    isPlayingRecording = false;
                    document.getElementById('playRecordingBtn').textContent = 'â–¶ï¸ æ’­æ”¾å½•éŸ³';
                }
                
                // é‡æ–°åˆå§‹åŒ–åª’ä½“å½•éŸ³å™¨
                const success = await initMediaRecorder();
                if (!success) return;
                
                // å¼€å§‹å½•éŸ³
                mediaRecorder.start();
                isRecording = true;
                
                // æ›´æ–°UI
                document.getElementById('voiceInputBtn').textContent = 'â¹ï¸ åœæ­¢å½•éŸ³';
                document.getElementById('voiceInputBtn').classList.add('recording');
                document.getElementById('voiceControlPanel').style.display = 'block';
                document.getElementById('playRecordingBtn').disabled = true;
                document.getElementById('submitRecordingBtn').disabled = true;
                document.getElementById('playbackProgress').style.display = 'none';
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('currentTime').textContent = '00:00';
                document.getElementById('totalTime').textContent = '00:00';
                
                // æ˜¾ç¤ºå½•éŸ³çŠ¶æ€
                showVoiceStatus('ğŸ¤ æ­£åœ¨å½•éŸ³ä¸­...', 'info');
                
                // å¼€å§‹è®¡æ—¶
                recordingSeconds = 0;
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    const minutes = Math.floor(recordingSeconds / 60);
                    const seconds = recordingSeconds % 60;
                    document.getElementById('recordingTimer').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    // è¾¾åˆ°æœ€å¤§å½•éŸ³æ—¶é—´è‡ªåŠ¨åœæ­¢
                    if (recordingSeconds >= maxRecordingTime) {
                        stopRecording();
                    }
                }, 1000);
                
                // å¼€å§‹å£°æ³¢åŠ¨ç”»
                startVoiceAnimation();
                
            } catch (error) {
                console.error('å¼€å§‹å½•éŸ³å¤±è´¥:', error);
                showVoiceStatus('âŒ å¼€å§‹å½•éŸ³å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // æ¸…é™¤è®¡æ—¶å™¨
                clearInterval(recordingTimer);
                
                showVoiceStatus('å¤„ç†å½•éŸ³ä¸­...', 'info');
            }
        }

        // æ’­æ”¾/åœæ­¢å½•éŸ³
        function togglePlayRecording() {
            if (!recordedAudioBlob) return;
            
            if (isPlayingRecording) {
                // åœæ­¢æ’­æ”¾
                playbackAudio.pause();
                clearInterval(playbackTimer);
                isPlayingRecording = false;
                document.getElementById('playRecordingBtn').textContent = 'â–¶ï¸ æ’­æ”¾å½•éŸ³';
            } else {
                // å¼€å§‹æ’­æ”¾
                playRecording();
            }
        }

        // æ’­æ”¾å½•éŸ³
        function playRecording() {
            if (recordedAudioBlob) {
                // åœæ­¢ä¹‹å‰çš„æ’­æ”¾
                if (playbackAudio) {
                    playbackAudio.pause();
                    clearInterval(playbackTimer);
                }
                
                const audioURL = URL.createObjectURL(recordedAudioBlob);
                playbackAudio = new Audio(audioURL);
                isPlayingRecording = true;
                
                // æ›´æ–°æ’­æ”¾æŒ‰é’®çŠ¶æ€
                document.getElementById('playRecordingBtn').textContent = 'â¸ï¸ åœæ­¢æ’­æ”¾';
                
                // æ˜¾ç¤ºæ’­æ”¾è¿›åº¦æ¡
                document.getElementById('playbackProgress').style.display = 'block';
                
                // è®¾ç½®æ’­æ”¾è¿›åº¦æ›´æ–°
                playbackTimer = setInterval(() => {
                    if (playbackAudio && isPlayingRecording) {
                        const currentTime = playbackAudio.currentTime;
                        const duration = recordedAudioDuration; // ä½¿ç”¨å®é™…å½•éŸ³æ—¶é•¿
                        
                        // æ›´æ–°è¿›åº¦æ¡
                        const progressPercent = (currentTime / duration) * 100;
                        document.getElementById('progressBar').style.width = `${progressPercent}%`;
                        
                        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
                        const currentMinutes = Math.floor(currentTime / 60);
                        const currentSeconds = Math.floor(currentTime % 60);
                        const totalMinutes = Math.floor(duration / 60);
                        const totalSeconds = Math.floor(duration % 60);
                        
                        document.getElementById('currentTime').textContent = 
                            `${currentMinutes.toString().padStart(2, '0')}:${currentSeconds.toString().padStart(2, '0')}`;
                        document.getElementById('totalTime').textContent = 
                            `${totalMinutes.toString().padStart(2, '0')}:${totalSeconds.toString().padStart(2, '0')}`;
                    }
                }, 100);
                
                playbackAudio.play();
                
                playbackAudio.onended = () => {
                    clearInterval(playbackTimer);
                    isPlayingRecording = false;
                    document.getElementById('playRecordingBtn').textContent = 'â–¶ï¸ æ’­æ”¾å½•éŸ³';
                    document.getElementById('progressBar').style.width = '100%';
                    
                    // æ›´æ–°å½“å‰æ—¶é—´ä¸ºæ€»æ—¶é—´
                    const totalMinutes = Math.floor(recordedAudioDuration / 60);
                    const totalSeconds = Math.floor(recordedAudioDuration % 60);
                    document.getElementById('currentTime').textContent = 
                        `${totalMinutes.toString().padStart(2, '0')}:${totalSeconds.toString().padStart(2, '0')}`;
                };
                
                playbackAudio.onpause = () => {
                    // å¦‚æœæ˜¯æ‰‹åŠ¨æš‚åœï¼Œä¸é‡ç½®æŒ‰é’®çŠ¶æ€ï¼ˆç”±togglePlayRecordingå¤„ç†ï¼‰
                    if (!playbackAudio.ended) {
                        clearInterval(playbackTimer);
                    }
                };
            }
        }

        // é‡æ–°å½•éŸ³
        function reRecord() {
            // åœæ­¢æ’­æ”¾
            if (playbackAudio) {
                playbackAudio.pause();
                clearInterval(playbackTimer);
                isPlayingRecording = false;
            }
            
            // é‡ç½®çŠ¶æ€
            audioChunks = [];
            recordedAudioBlob = null;
            recordedAudioDuration = 0;
            
            // é‡ç½®UI
            document.getElementById('playRecordingBtn').disabled = true;
            document.getElementById('submitRecordingBtn').disabled = true;
            document.getElementById('playRecordingBtn').textContent = 'â–¶ï¸ æ’­æ”¾å½•éŸ³';
            document.getElementById('recordingTimer').textContent = '00:00';
            document.getElementById('playbackProgress').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('currentTime').textContent = '00:00';
            document.getElementById('totalTime').textContent = '00:00';
            
            // å¼€å§‹æ–°çš„å½•éŸ³
            startRecording();
        }

        // å¼€å§‹å£°æ³¢åŠ¨ç”»
        function startVoiceAnimation() {
            const visualization = document.getElementById('voiceVisualization');
            visualization.innerHTML = '';
            
            // åˆ›å»ºå¤šä¸ªå£°æ³¢æ¡
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'voice-bar';
                bar.style.animationDelay = `${i * 0.05}s`;
                visualization.appendChild(bar);
            }
        }

        // åœæ­¢å£°æ³¢åŠ¨ç”»
        function stopVoiceAnimation() {
            const visualization = document.getElementById('voiceVisualization');
            visualization.innerHTML = '';
        }

        // åˆ‡æ¢å½•éŸ³çŠ¶æ€
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        // ç”Ÿæˆæ•…äº‹
        async function generateStory() {
            const keywords = document.getElementById('keywords').value.trim();
            const childGender = document.getElementById('childGender').value;
            const ageGroup = document.getElementById('ageGroup').value;
            const storyLength = document.getElementById('storyLength').value;
            const generateBtn = document.getElementById('generateBtn');
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const storyDisplay = document.getElementById('storyDisplay');
            const playBtn = document.getElementById('playBtn');

            if (!keywords) {
                showStatus('è¯·è¾“å…¥æ•…äº‹ä¸»é¢˜æˆ–å…³é”®è¯ï¼', 'error');
                return;
            }

            // é‡ç½®çŠ¶æ€
            generateBtn.disabled = true;
            playBtn.disabled = true;
            loading.style.display = 'block';
            updateStepIndicator(2);
            storyDisplay.innerHTML = '<p style="color: #7f8c8d; text-align: center; margin-top: 80px;">æ­£åœ¨åˆ›ä½œå®šåˆ¶å„¿ç«¥æ•…äº‹...</p>';
            document.getElementById('debugInfo').style.display = 'none';
            document.getElementById('audioInfo').style.display = 'none';
            document.getElementById('storyStats').innerHTML = '';
            
            if (currentAudioUrl) {
                URL.revokeObjectURL(currentAudioUrl);
                currentAudioUrl = null;
            }
            
            document.getElementById('audioPlayer').style.display = 'none';

            try {
                // ç¬¬ä¸€æ­¥ï¼šè°ƒç”¨DeepSeek APIç”Ÿæˆæ•…äº‹
                loadingText.textContent = 'ğŸ¤– æ­£åœ¨è°ƒç”¨DeepSeekç”Ÿæˆå®šåˆ¶æ•…äº‹...';
                
                const storyPrompt = generateStoryPrompt(keywords, childGender, ageGroup, storyLength);
                
                showDebugInfo(`ç”Ÿæˆæç¤ºè¯: ${storyPrompt}`);
                
                const storyResponse = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.deepseekApiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [{
                            role: 'user',
                            content: storyPrompt
                        }],
                        max_tokens: 4000,
                        temperature: 0.7
                    })
                });

                if (!storyResponse.ok) {
                    throw new Error(`DeepSeek APIé”™è¯¯: ${storyResponse.status}`);
                }

                const storyData = await storyResponse.json();
                const generatedStory = storyData.choices[0].message.content;

                // æ˜¾ç¤ºç”Ÿæˆçš„æ•…äº‹
                storyDisplay.innerHTML = `<p>${generatedStory.replace(/\n/g, '<br>')}</p>`;
                
                // æ˜¾ç¤ºæ•…äº‹ç»Ÿè®¡
                const wordCount = generatedStory.replace(/\s/g, '').length;
                const charCount = generatedStory.length;
                showStoryStats(wordCount, charCount);
                
                showStatus('æ•…äº‹ç”ŸæˆæˆåŠŸï¼æ­£åœ¨åˆæˆè¯­éŸ³...', 'success');

                // ç¬¬äºŒæ­¥ï¼šè°ƒç”¨MiniMaxå›½é™…ç«™ç‚¹APIåˆæˆè¯­éŸ³
                loadingText.textContent = 'ğŸµ æ­£åœ¨è°ƒç”¨MiniMaxå›½é™…ç«™ç‚¹åˆæˆè¯­éŸ³...';
                updateStepIndicator(3);

                const voiceId = document.getElementById('voiceSelect').value;
                
                // ä½¿ç”¨MiniMaxå›½é™…ç«™ç‚¹APIçš„æ­£ç¡®æ ¼å¼
                const requestData = {
                    model: 'speech-2.6-hd',
                    text: generatedStory,
                    stream: false,
                    voice_setting: {
                        voice_id: voiceId,
                        speed: ageGroup === "3-5å²" ? 0.8 : 0.9,
                        vol: 1.0,
                        pitch: 0,
                        emotion: 'happy'
                    },
                    audio_setting: {
                        format: "mp3",
                        sample_rate: 32000,
                        bitrate: 128000,
                        channel: 1
                    },
                    output_format: 'hex',
                    language_boost: 'Chinese'
                };
                
                showDebugInfo(`å‘é€è¯·æ±‚åˆ°MiniMaxå›½é™…ç«™ç‚¹APIï¼Œè¯­éŸ³ID: ${voiceId}`);
                
                const ttsResponse = await fetch('https://api.minimax.io/v1/t2a_v2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.minimaxApiKey}`
                    },
                    body: JSON.stringify(requestData)
                });

                if (!ttsResponse.ok) {
                    const errorText = await ttsResponse.text();
                    showDebugInfo(`MiniMax APIå“åº”çŠ¶æ€: ${ttsResponse.status}, å“åº”å†…å®¹: ${errorText}`);
                    throw new Error(`MiniMax TTS APIé”™è¯¯: ${ttsResponse.status}`);
                }

                // è§£æJSONå“åº”
                const responseJson = await ttsResponse.json();
                
                // æ£€æŸ¥å“åº”ç»“æ„
                if (responseJson.base_resp && responseJson.base_resp.status_code !== 0) {
                    showDebugInfo(`MiniMax APIé”™è¯¯: ${JSON.stringify(responseJson)}`);
                    throw new Error(`MiniMax APIé”™è¯¯: ${responseJson.base_resp.status_msg}`);
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰éŸ³é¢‘æ•°æ®
                if (!responseJson.data || !responseJson.data.audio) {
                    showDebugInfo(`APIå“åº”ä¸åŒ…å«éŸ³é¢‘æ•°æ®: ${JSON.stringify(responseJson)}`);
                    throw new Error('APIå“åº”ä¸åŒ…å«éŸ³é¢‘æ•°æ®');
                }

                // å¤„ç†åå…­è¿›åˆ¶éŸ³é¢‘æ•°æ®
                showDebugInfo('å¤„ç†åå…­è¿›åˆ¶éŸ³é¢‘æ•°æ®...');
                const audioHex = responseJson.data.audio;
                showDebugInfo(`éŸ³é¢‘åå…­è¿›åˆ¶æ•°æ®é•¿åº¦: ${audioHex.length} å­—ç¬¦`);
                
                // å°†åå…­è¿›åˆ¶å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
                const audioBytes = hexToBytes(audioHex);
                showDebugInfo(`è½¬æ¢ä¸º ${audioBytes.length} å­—èŠ‚`);
                
                // åˆ›å»ºBlob
                const audioBlob = new Blob([audioBytes], { type: 'audio/mpeg' });
                
                if (audioBlob.size === 0) {
                    throw new Error('è½¬æ¢åçš„éŸ³é¢‘æ•°æ®ä¸ºç©º');
                }
                
                showDebugInfo(`éŸ³é¢‘Blobå¤§å°: ${(audioBlob.size / 1024).toFixed(2)} KB`);
                
                currentAudioUrl = URL.createObjectURL(audioBlob);
                
                // è®¾ç½®éŸ³é¢‘æ’­æ”¾å™¨
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = currentAudioUrl;
                audioPlayer.style.display = 'block';

                // æ·»åŠ åŠ è½½äº‹ä»¶ç›‘å¬
                await new Promise((resolve, reject) => {
                    audioPlayer.onloadeddata = () => {
                        showDebugInfo('éŸ³é¢‘åŠ è½½æˆåŠŸ');
                        resolve();
                    };
                    audioPlayer.onerror = () => {
                        reject(new Error('éŸ³é¢‘åŠ è½½å¤±è´¥'));
                    };
                    
                    // è®¾ç½®è¶…æ—¶
                    setTimeout(() => {
                        reject(new Error('éŸ³é¢‘åŠ è½½è¶…æ—¶'));
                    }, 10000);
                });

                showStatus('æ•…äº‹å’Œè¯­éŸ³éƒ½å·²ç”Ÿæˆå®Œæˆï¼ç‚¹å‡»æ’­æ”¾æŒ‰é’®è†å¬ã€‚', 'success');
                playBtn.disabled = false;
                updateStepIndicator(1);
                
                // æ˜¾ç¤ºéŸ³é¢‘ä¿¡æ¯
                if (responseJson.extra_info) {
                    const info = responseJson.extra_info;
                    showAudioInfo(`æ•…äº‹æ—¶é•¿: ${Math.round(info.audio_length/1000)}ç§’, æ–‡ä»¶å¤§å°: ${(info.audio_size/1024).toFixed(1)}KB, æ ¼å¼: ${info.audio_format}`);
                }

            } catch (error) {
                console.error('Error:', error);
                showStatus(`ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
                storyDisplay.innerHTML = '<p style="color: #e74c3c; text-align: center; margin-top: 80px;">ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ£€æŸ¥APIå¯†é’¥ã€‚</p>';
            } finally {
                generateBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // æ’­æ”¾éŸ³é¢‘
        function playAudio() {
            const audioPlayer = document.getElementById('audioPlayer');
            const playBtn = document.getElementById('playBtn');
            
            if (currentAudioUrl && audioPlayer.src) {
                audioPlayer.play().then(() => {
                    playBtn.textContent = 'â¸ï¸ æ’­æ”¾ä¸­...';
                    showStatus('éŸ³é¢‘æ’­æ”¾ä¸­...', 'info');
                }).catch(error => {
                    showStatus('éŸ³é¢‘æ’­æ”¾å¤±è´¥: ' + error.message, 'error');
                });
                
                // ç›‘å¬æ’­æ”¾ç»“æŸ
                audioPlayer.onended = function() {
                    playBtn.textContent = 'ğŸ”Š æ’­æ”¾æ•…äº‹è¯­éŸ³';
                    showStatus('æ•…äº‹æ’­æ”¾å®Œæ¯•ï¼', 'success');
                };
            } else {
                showStatus('éŸ³é¢‘æœªå‡†å¤‡å¥½ï¼Œè¯·é‡æ–°ç”Ÿæˆ', 'error');
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            updateStepIndicator(1);
            
            // ç»‘å®šç”ŸæˆæŒ‰é’®äº‹ä»¶
            document.getElementById('generateBtn').addEventListener('click', generateStory);
            
            // ç»‘å®šæ’­æ”¾æŒ‰é’®äº‹ä»¶
            document.getElementById('playBtn').addEventListener('click', playAudio);
            
            // ç»‘å®šè¯­éŸ³è¾“å…¥æŒ‰é’®äº‹ä»¶
            document.getElementById('voiceInputBtn').addEventListener('click', toggleRecording);
            
            // ç»‘å®šå½•éŸ³æ§åˆ¶æŒ‰é’®äº‹ä»¶
            document.getElementById('playRecordingBtn').addEventListener('click', togglePlayRecording);
            document.getElementById('reRecordBtn').addEventListener('click', reRecord);
            document.getElementById('submitRecordingBtn').addEventListener('click', submitRecording);
            
            // ç»‘å®šæç¤ºè¯å»ºè®®æŒ‰é’®äº‹ä»¶
            document.getElementById('suggestion1').addEventListener('click', function() {
                document.getElementById('keywords').value = this.textContent;
            });
            
            document.getElementById('suggestion2').addEventListener('click', function() {
                document.getElementById('keywords').value = this.textContent;
            });
            
            document.getElementById('suggestion3').addEventListener('click', function() {
                document.getElementById('keywords').value = this.textContent;
            });
            
            document.getElementById('randomSuggestion').addEventListener('click', setRandomPrompt);
            
            // å›è½¦é”®è§¦å‘ç”Ÿæˆ
            document.getElementById('keywords').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    generateStory();
                }
            });

            // é¡µé¢åŠ è½½æ—¶è®¾ç½®éšæœºæç¤ºè¯
            setRandomPrompt();
            
            // æ˜¾ç¤ºåˆå§‹çŠ¶æ€
            showStatus('å‡†å¤‡å¥½ç”Ÿæˆå®šåˆ¶å„¿ç«¥æ•…äº‹ï¼è¯·è®¾ç½®æ•…äº‹å‚æ•°å¹¶ç‚¹å‡»ç”ŸæˆæŒ‰é’®ã€‚', 'info');
        });

        // æ¸…ç†éŸ³é¢‘URLé˜²æ­¢å†…å­˜æ³„æ¼
        window.addEventListener('beforeunload', function() {
            if (currentAudioUrl) {
                URL.revokeObjectURL(currentAudioUrl);
            }
            if (playbackAudio) {
                playbackAudio.pause();
            }
        });
    </script>
</body>
</html>