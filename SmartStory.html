<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå„¿ç«¥æ•…äº‹ç”Ÿæˆå™¨ - MiniMaxå›½é™…ç«™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffd93d);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .selection-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .selection-group {
                grid-template-columns: 1fr;
            }
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input[type="text"], select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .generate-btn {
            background: #4ecdc4;
            color: white;
        }

        .generate-btn:hover:not(:disabled) {
            background: #3db4ac;
            transform: translateY(-2px);
        }

        .play-btn {
            background: #ff6b6b;
            color: white;
        }

        .play-btn:hover:not(:disabled) {
            background: #ff5252;
            transform: translateY(-2px);
        }

        .voice-input-btn {
            background: #6c5ce7;
            color: white;
            padding: 10px 15px;
            margin-top: 10px;
            width: 100%;
        }

        .voice-input-btn:hover:not(:disabled) {
            background: #5b4cd8;
            transform: translateY(-2px);
        }

        .voice-input-btn.recording {
            background: #e74c3c;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .output-section {
            margin-top: 30px;
        }

        .story-display {
            background: #f8f9fa;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 20px;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
            line-height: 1.8;
            font-size: 16px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4ecdc4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .audio-controls {
            margin-top: 20px;
            text-align: center;
        }

        .audio-controls audio {
            width: 100%;
            margin-top: 10px;
            border-radius: 12px;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e1e8ed;
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #bdc3c7;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .step.active .step-number {
            background: #4ecdc4;
        }

        .step.completed .step-number {
            background: #ff6b6b;
        }

        .step-text {
            font-size: 14px;
            color: #7f8c8d;
            text-align: center;
        }

        .step.active .step-text {
            color: #4ecdc4;
            font-weight: 600;
        }

        .step.completed .step-text {
            color: #ff6b6b;
        }

        .debug-info {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
            color: #666;
            display: none;
        }

        .audio-info {
            margin-top: 10px;
            padding: 10px;
            background: #e8f4fc;
            border-radius: 5px;
            font-size: 14px;
            display: none;
        }

        .story-stats {
            margin-top: 10px;
            text-align: right;
            font-size: 14px;
            color: #7f8c8d;
        }

        .prompt-suggestions {
            margin-top: 10px;
            font-size: 14px;
            color: #7f8c8d;
            text-align: center;
        }

        .prompt-suggestions button {
            background: none;
            border: none;
            color: #3498db;
            text-decoration: underline;
            cursor: pointer;
            padding: 0;
            margin: 0 5px;
            font-size: 14px;
        }

        .voice-status {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§šâ€â™€ï¸ AIå„¿ç«¥éŸ³é¢‘æ•…äº‹ç”Ÿæˆå™¨</h1>
            <p>ä½¿ç”¨DeepSeek/MiniMaxç”Ÿæˆå„¿ç«¥éŸ³é¢‘æ•…äº‹</p>
        </div>

        <div class="content">
            <div class="step-indicator">
                <div class="step completed" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-text">è®¾ç½®æ•…äº‹å‚æ•°</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-text">ç”Ÿæˆæ•…äº‹</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-text">åˆæˆè¯­éŸ³</div>
                </div>
            </div>

            <div class="input-section">
                <div class="input-group">
                    <label for="keywords">æ•…äº‹ä¸»é¢˜æˆ–å…³é”®è¯ï¼š</label>
                    <input type="text" id="keywords" placeholder="ä¾‹å¦‚ï¼šå‹‡æ•¢çš„å°å…”å­ã€é­”æ³•æ£®æ—å†’é™©ã€å‹è°Šçš„åŠ›é‡">
                    <div class="prompt-suggestions" id="promptSuggestions">
                        è¯•è¯•è¿™äº›ä¸»é¢˜: 
                        <button id="suggestion1">å‹‡æ•¢çš„å°å…”å­</button>
                        <button id="suggestion2">é­”æ³•æ£®æ—å†’é™©</button>
                        <button id="suggestion3">å‹è°Šçš„åŠ›é‡</button>
                        <button id="randomSuggestion">éšæœºä¸»é¢˜</button>
                    </div>
                    <button class="voice-input-btn" id="voiceInputBtn">
                        ğŸ¤ è¯­éŸ³è¾“å…¥æç¤ºè¯
                    </button>
                    <div class="voice-status" id="voiceStatus"></div>
                </div>

                <div class="selection-group">
                    <div class="input-group">
                        <label for="childGender">å„¿ç«¥æ€§åˆ«ï¼š</label>
                        <select id="childGender">
                            <option value="ç”·å­©">ğŸ‘¦ ç”·å­©</option>
                            <option value="å¥³å­©">ğŸ‘§ å¥³å­©</option>
                            <option value="ä¸é™" selected>ğŸ‘¦ğŸ‘§ ä¸é™</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="ageGroup">å¹´é¾„æ®µï¼š</label>
                        <select id="ageGroup">
                            <option value="3-5å²">3-5å²ï¼ˆå¹¼å„¿ï¼‰</option>
                            <option value="6-8å²" selected>6-8å²ï¼ˆå„¿ç«¥ï¼‰</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="storyLength">æ•…äº‹é•¿åº¦ï¼š</label>
                        <select id="storyLength">
                            <option value="500">500å­—ï¼ˆçŸ­ç¯‡ï¼‰</option>
                            <option value="1000" selected>1000å­—ï¼ˆä¸­ç¯‡ï¼‰</option>
                            <option value="2000">2000å­—ï¼ˆé•¿ç¯‡ï¼‰</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="voiceSelect">è®²è¿°è€…å£°éŸ³ï¼š</label>
                        <select id="voiceSelect">
                            <!-- MiniMaxå›½é™…ç«™ç‚¹æ”¯æŒçš„è¯­éŸ³ID -->
                            <option value="moss_audio_ce44fc67-7ce3-11f0-8de5-96e35d26fb85">ğŸ¤– è«æ–¯ä¸­æ–‡éŸ³è‰²1</option>
                            <option value="moss_audio_aaa1346a-7ce7-11f0-8e61-2e6e3c7ee85d">ğŸ¤– è«æ–¯ä¸­æ–‡éŸ³è‰²2</option>
                            <option value="Chinese (Mandarin)_Lyrical_Voice">ğŸµ ä¸­æ–‡æŠ’æƒ…éŸ³è‰²</option>
                            <option value="Chinese (Mandarin)_HK_Flight_Attendant">âœˆï¸ ä¸­æ–‡ç©ºä¹˜éŸ³è‰²</option>
                            <option value="English_expressive_narrator">ğŸ­ è‹±æ–‡å¯Œæœ‰è¡¨ç°åŠ›çš„æ—ç™½</option>
                            <option value="English_Graceful_Lady">ğŸ‘© è‹±æ–‡ä¼˜é›…çš„å¥³å£°</option>
                            <option value="English_Insightful_Speaker">ğŸ’¡ è‹±æ–‡å¯Œæœ‰æ´å¯ŸåŠ›çš„æ¼”è®²è€…</option>
                        </select>
                    </div>
                </div>

                <div class="button-group">
                    <button class="generate-btn" id="generateBtn">
                        ğŸª„ ç”Ÿæˆå®šåˆ¶æ•…äº‹
                    </button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loadingText">æ­£åœ¨ç”Ÿæˆæ•…äº‹ï¼Œè¯·ç¨å€™...</p>
            </div>

            <div id="statusMessage"></div>

            <div class="output-section">
                <label>ç”Ÿæˆçš„å„¿ç«¥æ•…äº‹ï¼š</label>
                <div class="story-display" id="storyDisplay">
                    <p style="color: #7f8c8d; text-align: center; margin-top: 80px;">
                        è®¾ç½®æ•…äº‹å‚æ•°å¹¶ç‚¹å‡»ç”Ÿæˆï¼Œæ‚¨å°†ä¼šçœ‹åˆ°ä¸€ä¸ªç²¾å½©çš„å®šåˆ¶å„¿ç«¥æ•…äº‹...
                    </p>
                </div>
                <div class="story-stats" id="storyStats"></div>

                <div class="debug-info" id="debugInfo"></div>
                <div class="audio-info" id="audioInfo"></div>

                <div class="audio-controls">
                    <button class="play-btn" id="playBtn" disabled>
                        ğŸ”Š æ’­æ”¾æ•…äº‹è¯­éŸ³
                    </button>
                    <audio id="audioPlayer" controls style="display: none;"></audio>
                </div>
            </div>
        </div>
    </div>

    <script>
        // APIå¯†é’¥é…ç½®
        const CONFIG = {
            deepseekApiKey: 'sk-aae2a862b3ab4c498fa91f73c76ef9d3',
            minimaxApiKey: 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJHcm91cE5hbWUiOiJEb25neHUgU2hlbiIsIlVzZXJOYW1lIjoiVmlydHVhbCBWaWV3IFRlY2hub2xvZ3kiLCJBY2NvdW50IjoiIiwiU3ViamVjdElEIjoiMTg5MDEzNjYyNDY1MDUyMzU2NyIsIlBob25lIjoiIiwiR3JvdXBJRCI6IjE4OTAxMzY2MjQ2NDIxMzQ5NTkiLCJQYWdlTmFtZSI6IiIsIk1haWwiOiJkYW5ueS5kb25neHUuc2hlbkBnbWFpbC5jb20iLCJDcmVhdGVUaW1lIjoiMjAyNS0xMS0yMyAyMTozNzowMCIsIlRva2VuVHlwZSI6MSwiaXNzIjoibWluaW1heCJ9.skY-6yvS8VV321ta7LxzoubBOWhlAzaJDrQ4HbK3_vaVtKMPuakO1lGBYJeGJDhQ12xhnlGn5z5fjQVb99N9BkekaNUY2n3PHdO01Ub6Wgfe3w62sGx538WhidIlwvgEMsFNhGbtHj2FGwaef6ZmGlxM6JmXg3J_bYSKYNu5UwlvZeXq3mddJdBCRlZ3d5RzKx9XpxpmeeRh_VzHlW6af5u1gbfD5Lc9vrxa5aNLqbYgUL6DO_RkXsy7kszlEnzOT-lWslgWmwh2lDS28LDEKacEZCymva196R-Dg2N1klgP585T1ZVud7UjWUZ445kmzU0W2tAroGDuQ9rCZVdBAA',
            baiduSpeech: {
                appId: '7258968',
                apiKey: 'aFlSHz5qGHV2ZID4daou3Gqq',
                secretKey: 'Jva3tSRyrH3fLHW98cxGhlDKQfCQ6RsJ'
            }
        };

        // å…¨å±€å˜é‡
        let currentAudioUrl = null;
        let recognition = null;
        let isRecording = false;

        // æœ¬åœ°æç¤ºè¯åº“
        const PROMPT_SUGGESTIONS = [
            "å‹‡æ•¢çš„å°å…”å­",
            "é­”æ³•æ£®æ—å†’é™©", 
            "å‹è°Šçš„åŠ›é‡",
            "æµ·åº•ä¸–ç•Œå¥‡é‡",
            "å¤ªç©ºæ¢é™©è®°",
            "ä¼šè¯´è¯çš„å°åŠ¨ç‰©",
            "å½©è™¹æ¡¥çš„ç§˜å¯†",
            "æ¢¦æƒ³æˆçœŸçš„æ•…äº‹",
            "å‹‡æ•¢é¢å¯¹ææƒ§",
            "åˆ†äº«çš„å¿«ä¹",
            "å¸®åŠ©ä»–äººçš„å°è‹±é›„",
            "å››å­£çš„å˜åŒ–",
            "æ˜Ÿæ˜Ÿçš„æ„¿æœ›",
            "æœˆäº®çš„ç§˜å¯†",
            "å¤ªé˜³çš„å¾®ç¬‘"
        ];

        // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
        function updateStepIndicator(step) {
            const steps = ['step1', 'step2', 'step3'];
            steps.forEach((stepId, index) => {
                const stepElement = document.getElementById(stepId);
                if (index + 1 < step) {
                    stepElement.classList.add('completed');
                    stepElement.classList.remove('active');
                } else if (index + 1 === step) {
                    stepElement.classList.add('active');
                    stepElement.classList.remove('completed');
                } else {
                    stepElement.classList.remove('active', 'completed');
                }
            });
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);
            }
        }

        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function showDebugInfo(info) {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = `<strong>è°ƒè¯•ä¿¡æ¯:</strong> ${info}`;
            debugDiv.style.display = 'block';
        }

        // æ˜¾ç¤ºéŸ³é¢‘ä¿¡æ¯
        function showAudioInfo(info) {
            const audioInfo = document.getElementById('audioInfo');
            audioInfo.innerHTML = info;
            audioInfo.style.display = 'block';
        }

        // æ˜¾ç¤ºæ•…äº‹ç»Ÿè®¡ä¿¡æ¯
        function showStoryStats(wordCount, charCount) {
            const statsDiv = document.getElementById('storyStats');
            statsDiv.innerHTML = `å­—æ•°: ${wordCount} | å­—ç¬¦æ•°: ${charCount}`;
        }

        // æ˜¾ç¤ºè¯­éŸ³çŠ¶æ€
        function showVoiceStatus(message, type = 'info') {
            const voiceStatus = document.getElementById('voiceStatus');
            voiceStatus.innerHTML = message;
            voiceStatus.style.display = 'block';
            voiceStatus.className = `voice-status ${type}`;
        }

        // éšè—è¯­éŸ³çŠ¶æ€
        function hideVoiceStatus() {
            const voiceStatus = document.getElementById('voiceStatus');
            voiceStatus.style.display = 'none';
        }

        // åå…­è¿›åˆ¶å­—ç¬¦ä¸²è½¬å­—èŠ‚æ•°ç»„
        function hexToBytes(hex) {
            const bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substr(i, 2), 16));
            }
            return new Uint8Array(bytes);
        }

        // éšæœºç”Ÿæˆæç¤ºè¯
        function generateRandomPrompt() {
            const randomIndex = Math.floor(Math.random() * PROMPT_SUGGESTIONS.length);
            return PROMPT_SUGGESTIONS[randomIndex];
        }

        // è®¾ç½®éšæœºæç¤ºè¯
        function setRandomPrompt() {
            const keywordsInput = document.getElementById('keywords');
            keywordsInput.value = generateRandomPrompt();
        }

        // ç”Ÿæˆæ•…äº‹æç¤ºè¯
        function generateStoryPrompt(keywords, childGender, ageGroup, storyLength) {
            let prompt = `è¯·åˆ›ä½œä¸€ä¸ªå„¿ç«¥æ•…äº‹ï¼Œä¸»é¢˜æ˜¯å…³äº"${keywords}"ã€‚`;
            
            // æ ¹æ®æ€§åˆ«è°ƒæ•´
            if (childGender !== "ä¸é™") {
                prompt += ` è¿™ä¸ªæ•…äº‹ä¸»è¦é¢å‘${childGender}ï¼Œ`;
            }
            
            // æ ¹æ®å¹´é¾„æ®µè°ƒæ•´
            if (ageGroup === "3-5å²") {
                prompt += ` é€‚åˆ3-5å²å¹¼å„¿ï¼Œè¦æ±‚è¯­è¨€ç®€å•æ˜“æ‡‚ï¼Œå¥å­çŸ­å°ï¼Œæƒ…èŠ‚ç®€å•æ˜äº†ï¼Œå¯Œæœ‰ç«¥è¶£å’Œæƒ³è±¡åŠ›ã€‚`;
            } else {
                prompt += ` é€‚åˆ6-8å²å„¿ç«¥ï¼Œå¯ä»¥æœ‰ç¨å¾®å¤æ‚ä¸€ç‚¹çš„æƒ…èŠ‚å’Œæ›´å¤šç»†èŠ‚ï¼Œä½†ä»è¦ä¿æŒè¯­è¨€ç”ŸåŠ¨æœ‰è¶£ã€‚`;
            }
            
            // æ ¹æ®å­—æ•°è°ƒæ•´
            prompt += ` æ•…äº‹é•¿åº¦å¤§çº¦${storyLength}å­—ã€‚`;
            
            // æ•…äº‹è¦æ±‚
            prompt += ` è¦æ±‚æ•…äº‹æ¸©é¦¨ã€ç§¯æå‘ä¸Šã€å¯Œæœ‰æ•™è‚²æ„ä¹‰ï¼ŒåŒ…å«æ˜ç¡®çš„å¼€å§‹ã€å‘å±•å’Œç»“å°¾ï¼Œä½†è¯·ä¸è¦ä½¿ç”¨"èµ·æ‰¿è½¬åˆ"è¿™æ ·çš„æœ¯è¯­ã€‚`;
            
            // è¯­è¨€é£æ ¼
            prompt += ` ä½¿ç”¨é€‚åˆå„¿ç«¥çš„è¯­è¨€é£æ ¼ï¼Œé¿å…å¤æ‚è¯æ±‡ï¼Œå¯ä»¥é€‚å½“ä½¿ç”¨æ‹Ÿå£°è¯å’Œé‡å¤å¥å¼å¢å¼ºè¶£å‘³æ€§ã€‚`;
            
            return prompt;
        }

        // ç™¾åº¦è¯­éŸ³è¯†åˆ« - è·å–è®¿é—®ä»¤ç‰Œ
        async function getBaiduAccessToken() {
            try {
                const response = await fetch(`https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${CONFIG.baiduSpeech.apiKey}&client_secret=${CONFIG.baiduSpeech.secretKey}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.access_token) {
                    return data.access_token;
                } else {
                    throw new Error('æ— æ³•è·å–ç™¾åº¦è¯­éŸ³è¯†åˆ«è®¿é—®ä»¤ç‰Œ');
                }
            } catch (error) {
                console.error('è·å–ç™¾åº¦è¯­éŸ³è¯†åˆ«ä»¤ç‰Œå¤±è´¥:', error);
                throw error;
            }
        }

        // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
        async function initSpeechRecognition() {
            try {
                // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³è¯†åˆ«
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeã€Edgeç­‰ç°ä»£æµè§ˆå™¨');
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                // é…ç½®è¯†åˆ«å‚æ•°
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'zh-CN';
                
                // è®¾ç½®äº‹ä»¶å¤„ç†
                recognition.onstart = function() {
                    isRecording = true;
                    document.getElementById('voiceInputBtn').classList.add('recording');
                    showVoiceStatus('ğŸ¤ æ­£åœ¨è†å¬ä¸­...è¯·å¼€å§‹è¯´è¯', 'info');
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('keywords').value = transcript;
                    showVoiceStatus(`âœ… è¯†åˆ«æˆåŠŸ: "${transcript}"`, 'success');
                    
                    // 3ç§’åéšè—çŠ¶æ€æ¶ˆæ¯
                    setTimeout(() => {
                        hideVoiceStatus();
                    }, 3000);
                };
                
                recognition.onerror = function(event) {
                    console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                    let errorMessage = 'è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•';
                    
                    switch(event.error) {
                        case 'not-allowed':
                            errorMessage = 'è¯·å…è®¸æµè§ˆå™¨ä½¿ç”¨éº¦å…‹é£æƒé™';
                            break;
                        case 'no-speech':
                            errorMessage = 'æ²¡æœ‰æ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•';
                            break;
                        case 'audio-capture':
                            errorMessage = 'æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥è®¾å¤‡';
                            break;
                    }
                    
                    showVoiceStatus(`âŒ ${errorMessage}`, 'error');
                    stopRecording();
                };
                
                recognition.onend = function() {
                    stopRecording();
                };
                
                return true;
            } catch (error) {
                console.error('åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
                showVoiceStatus(`âŒ ${error.message}`, 'error');
                return false;
            }
        }

        // å¼€å§‹å½•éŸ³
        function startRecording() {
            if (!recognition) {
                if (!initSpeechRecognition()) {
                    return;
                }
            }
            
            try {
                recognition.start();
            } catch (error) {
                console.error('å¼€å§‹å½•éŸ³å¤±è´¥:', error);
                showVoiceStatus('âŒ å¼€å§‹å½•éŸ³å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            isRecording = false;
            document.getElementById('voiceInputBtn').classList.remove('recording');
            
            if (recognition) {
                try {
                    recognition.stop();
                } catch (error) {
                    // å¿½ç•¥åœæ­¢æ—¶çš„é”™è¯¯
                }
            }
        }

        // åˆ‡æ¢å½•éŸ³çŠ¶æ€
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        // ç”Ÿæˆæ•…äº‹
        async function generateStory() {
            const keywords = document.getElementById('keywords').value.trim();
            const childGender = document.getElementById('childGender').value;
            const ageGroup = document.getElementById('ageGroup').value;
            const storyLength = document.getElementById('storyLength').value;
            const generateBtn = document.getElementById('generateBtn');
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const storyDisplay = document.getElementById('storyDisplay');
            const playBtn = document.getElementById('playBtn');

            if (!keywords) {
                showStatus('è¯·è¾“å…¥æ•…äº‹ä¸»é¢˜æˆ–å…³é”®è¯ï¼', 'error');
                return;
            }

            // é‡ç½®çŠ¶æ€
            generateBtn.disabled = true;
            playBtn.disabled = true;
            loading.style.display = 'block';
            updateStepIndicator(2);
            storyDisplay.innerHTML = '<p style="color: #7f8c8d; text-align: center; margin-top: 80px;">æ­£åœ¨åˆ›ä½œå®šåˆ¶å„¿ç«¥æ•…äº‹...</p>';
            document.getElementById('debugInfo').style.display = 'none';
            document.getElementById('audioInfo').style.display = 'none';
            document.getElementById('storyStats').innerHTML = '';
            
            if (currentAudioUrl) {
                URL.revokeObjectURL(currentAudioUrl);
                currentAudioUrl = null;
            }
            
            document.getElementById('audioPlayer').style.display = 'none';

            try {
                // ç¬¬ä¸€æ­¥ï¼šè°ƒç”¨DeepSeek APIç”Ÿæˆæ•…äº‹
                loadingText.textContent = 'ğŸ¤– æ­£åœ¨è°ƒç”¨DeepSeekç”Ÿæˆå®šåˆ¶æ•…äº‹...';
                
                const storyPrompt = generateStoryPrompt(keywords, childGender, ageGroup, storyLength);
                
                showDebugInfo(`ç”Ÿæˆæç¤ºè¯: ${storyPrompt}`);
                
                const storyResponse = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.deepseekApiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [{
                            role: 'user',
                            content: storyPrompt
                        }],
                        max_tokens: 4000,
                        temperature: 0.7
                    })
                });

                if (!storyResponse.ok) {
                    throw new Error(`DeepSeek APIé”™è¯¯: ${storyResponse.status}`);
                }

                const storyData = await storyResponse.json();
                const generatedStory = storyData.choices[0].message.content;

                // æ˜¾ç¤ºç”Ÿæˆçš„æ•…äº‹
                storyDisplay.innerHTML = `<p>${generatedStory.replace(/\n/g, '<br>')}</p>`;
                
                // æ˜¾ç¤ºæ•…äº‹ç»Ÿè®¡
                const wordCount = generatedStory.replace(/\s/g, '').length;
                const charCount = generatedStory.length;
                showStoryStats(wordCount, charCount);
                
                showStatus('æ•…äº‹ç”ŸæˆæˆåŠŸï¼æ­£åœ¨åˆæˆè¯­éŸ³...', 'success');

                // ç¬¬äºŒæ­¥ï¼šè°ƒç”¨MiniMaxå›½é™…ç«™ç‚¹APIåˆæˆè¯­éŸ³
                loadingText.textContent = 'ğŸµ æ­£åœ¨è°ƒç”¨MiniMaxå›½é™…ç«™ç‚¹åˆæˆè¯­éŸ³...';
                updateStepIndicator(3);

                const voiceId = document.getElementById('voiceSelect').value;
                
                // ä½¿ç”¨MiniMaxå›½é™…ç«™ç‚¹APIçš„æ­£ç¡®æ ¼å¼
                const requestData = {
                    model: 'speech-2.6-hd',
                    text: generatedStory,
                    stream: false,
                    voice_setting: {
                        voice_id: voiceId,
                        speed: ageGroup === "3-5å²" ? 0.8 : 0.9,
                        vol: 1.0,
                        pitch: 0,
                        emotion: 'happy'
                    },
                    audio_setting: {
                        format: "mp3",
                        sample_rate: 32000,
                        bitrate: 128000,
                        channel: 1
                    },
                    output_format: 'hex',
                    language_boost: 'Chinese'
                };
                
                showDebugInfo(`å‘é€è¯·æ±‚åˆ°MiniMaxå›½é™…ç«™ç‚¹APIï¼Œè¯­éŸ³ID: ${voiceId}`);
                
                const ttsResponse = await fetch('https://api.minimax.io/v1/t2a_v2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.minimaxApiKey}`
                    },
                    body: JSON.stringify(requestData)
                });

                if (!ttsResponse.ok) {
                    const errorText = await ttsResponse.text();
                    showDebugInfo(`MiniMax APIå“åº”çŠ¶æ€: ${ttsResponse.status}, å“åº”å†…å®¹: ${errorText}`);
                    throw new Error(`MiniMax TTS APIé”™è¯¯: ${ttsResponse.status}`);
                }

                // è§£æJSONå“åº”
                const responseJson = await ttsResponse.json();
                
                // æ£€æŸ¥å“åº”ç»“æ„
                if (responseJson.base_resp && responseJson.base_resp.status_code !== 0) {
                    showDebugInfo(`MiniMax APIé”™è¯¯: ${JSON.stringify(responseJson)}`);
                    throw new Error(`MiniMax APIé”™è¯¯: ${responseJson.base_resp.status_msg}`);
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰éŸ³é¢‘æ•°æ®
                if (!responseJson.data || !responseJson.data.audio) {
                    showDebugInfo(`APIå“åº”ä¸åŒ…å«éŸ³é¢‘æ•°æ®: ${JSON.stringify(responseJson)}`);
                    throw new Error('APIå“åº”ä¸åŒ…å«éŸ³é¢‘æ•°æ®');
                }

                // å¤„ç†åå…­è¿›åˆ¶éŸ³é¢‘æ•°æ®
                showDebugInfo('å¤„ç†åå…­è¿›åˆ¶éŸ³é¢‘æ•°æ®...');
                const audioHex = responseJson.data.audio;
                showDebugInfo(`éŸ³é¢‘åå…­è¿›åˆ¶æ•°æ®é•¿åº¦: ${audioHex.length} å­—ç¬¦`);
                
                // å°†åå…­è¿›åˆ¶å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
                const audioBytes = hexToBytes(audioHex);
                showDebugInfo(`è½¬æ¢ä¸º ${audioBytes.length} å­—èŠ‚`);
                
                // åˆ›å»ºBlob
                const audioBlob = new Blob([audioBytes], { type: 'audio/mpeg' });
                
                if (audioBlob.size === 0) {
                    throw new Error('è½¬æ¢åçš„éŸ³é¢‘æ•°æ®ä¸ºç©º');
                }
                
                showDebugInfo(`éŸ³é¢‘Blobå¤§å°: ${(audioBlob.size / 1024).toFixed(2)} KB`);
                
                currentAudioUrl = URL.createObjectURL(audioBlob);
                
                // è®¾ç½®éŸ³é¢‘æ’­æ”¾å™¨
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = currentAudioUrl;
                audioPlayer.style.display = 'block';

                // æ·»åŠ åŠ è½½äº‹ä»¶ç›‘å¬
                await new Promise((resolve, reject) => {
                    audioPlayer.onloadeddata = () => {
                        showDebugInfo('éŸ³é¢‘åŠ è½½æˆåŠŸ');
                        resolve();
                    };
                    audioPlayer.onerror = () => {
                        reject(new Error('éŸ³é¢‘åŠ è½½å¤±è´¥'));
                    };
                    
                    // è®¾ç½®è¶…æ—¶
                    setTimeout(() => {
                        reject(new Error('éŸ³é¢‘åŠ è½½è¶…æ—¶'));
                    }, 10000);
                });

                showStatus('æ•…äº‹å’Œè¯­éŸ³éƒ½å·²ç”Ÿæˆå®Œæˆï¼ç‚¹å‡»æ’­æ”¾æŒ‰é’®è†å¬ã€‚', 'success');
                playBtn.disabled = false;
                updateStepIndicator(1);
                
                // æ˜¾ç¤ºéŸ³é¢‘ä¿¡æ¯
                if (responseJson.extra_info) {
                    const info = responseJson.extra_info;
                    showAudioInfo(`æ•…äº‹æ—¶é•¿: ${Math.round(info.audio_length/1000)}ç§’, æ–‡ä»¶å¤§å°: ${(info.audio_size/1024).toFixed(1)}KB, æ ¼å¼: ${info.audio_format}`);
                }

            } catch (error) {
                console.error('Error:', error);
                showStatus(`ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
                storyDisplay.innerHTML = '<p style="color: #e74c3c; text-align: center; margin-top: 80px;">ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ£€æŸ¥APIå¯†é’¥ã€‚</p>';
            } finally {
                generateBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // æ’­æ”¾éŸ³é¢‘
        function playAudio() {
            const audioPlayer = document.getElementById('audioPlayer');
            const playBtn = document.getElementById('playBtn');
            
            if (currentAudioUrl && audioPlayer.src) {
                audioPlayer.play().then(() => {
                    playBtn.textContent = 'â¸ï¸ æ’­æ”¾ä¸­...';
                    showStatus('éŸ³é¢‘æ’­æ”¾ä¸­...', 'info');
                }).catch(error => {
                    showStatus('éŸ³é¢‘æ’­æ”¾å¤±è´¥: ' + error.message, 'error');
                });
                
                // ç›‘å¬æ’­æ”¾ç»“æŸ
                audioPlayer.onended = function() {
                    playBtn.textContent = 'ğŸ”Š æ’­æ”¾æ•…äº‹è¯­éŸ³';
                    showStatus('æ•…äº‹æ’­æ”¾å®Œæ¯•ï¼', 'success');
                };
            } else {
                showStatus('éŸ³é¢‘æœªå‡†å¤‡å¥½ï¼Œè¯·é‡æ–°ç”Ÿæˆ', 'error');
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            updateStepIndicator(1);
            
            // ç»‘å®šç”ŸæˆæŒ‰é’®äº‹ä»¶
            document.getElementById('generateBtn').addEventListener('click', generateStory);
            
            // ç»‘å®šæ’­æ”¾æŒ‰é’®äº‹ä»¶
            document.getElementById('playBtn').addEventListener('click', playAudio);
            
            // ç»‘å®šè¯­éŸ³è¾“å…¥æŒ‰é’®äº‹ä»¶
            document.getElementById('voiceInputBtn').addEventListener('click', toggleRecording);
            
            // ç»‘å®šæç¤ºè¯å»ºè®®æŒ‰é’®äº‹ä»¶
            document.getElementById('suggestion1').addEventListener('click', function() {
                document.getElementById('keywords').value = this.textContent;
            });
            
            document.getElementById('suggestion2').addEventListener('click', function() {
                document.getElementById('keywords').value = this.textContent;
            });
            
            document.getElementById('suggestion3').addEventListener('click', function() {
                document.getElementById('keywords').value = this.textContent;
            });
            
            document.getElementById('randomSuggestion').addEventListener('click', setRandomPrompt);
            
            // å›è½¦é”®è§¦å‘ç”Ÿæˆ
            document.getElementById('keywords').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    generateStory();
                }
            });

            // é¡µé¢åŠ è½½æ—¶è®¾ç½®éšæœºæç¤ºè¯
            setRandomPrompt();
            
            // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
            initSpeechRecognition();
            
            // æ˜¾ç¤ºåˆå§‹çŠ¶æ€
            showStatus('å‡†å¤‡å¥½ç”Ÿæˆå®šåˆ¶å„¿ç«¥æ•…äº‹ï¼è¯·è®¾ç½®æ•…äº‹å‚æ•°å¹¶ç‚¹å‡»ç”ŸæˆæŒ‰é’®ã€‚', 'info');
        });

        // æ¸…ç†éŸ³é¢‘URLé˜²æ­¢å†…å­˜æ³„æ¼
        window.addEventListener('beforeunload', function() {
            if (currentAudioUrl) {
                URL.revokeObjectURL(currentAudioUrl);
            }
        });
    </script>
</body>
</html>